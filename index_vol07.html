<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Chosen Palette: "Power Red & Night Ops" - A high-contrast theme using a dominant black/dark gray background (#1a1a1a, #2d2d2d), an energetic and motivational primary red (#dc2626), and clean white/light gray text (#f8f9fa) for clarity and impact, tailored to a fitness-oriented audience. -->
    <!-- Application Structure Plan: The application employs a linear, funnel-based user journey designed for maximum engagement and conversion. It starts with a low-friction three-field input form to capture essential user data (weight, goal, activity). This leads to an animated loading state that builds anticipation before revealing the primary resultâ€”the daily protein targetâ€”in a visually impactful card. The user is then guided sequentially through increasingly detailed information: a full macronutrient breakdown, the actionable daily meal plan, a helpful shopping list with affiliate link potential, and finally, a clear call-to-action for a related physical product. This progressive disclosure of information prevents overwhelm and systematically builds user investment, making the final conversion request more effective. The structure was chosen to transform a simple calculator into a compelling, story-driven experience that guides the user from initial curiosity to a high-value outcome and a potential business lead. -->
    <!-- Visualization & Content Choices: 
        - Report Info: User's calculated daily protein, calories, carbs, and fat. Goal: Inform/Impact. Viz/Method: Large, animated numerical display in a styled "result-card" (#mainProteinCard). Interaction: Subtle pulsing and scaling on hover. Justification: Creates a "wow" moment, making the primary result feel significant and rewarding. Library: HTML/CSS animations.
        - Report Info: Full macronutrient breakdown (P/C/F). Goal: Compare/Inform. Viz/Method: Structured HTML list with clear labels and styled badges. Interaction: Static display. Justification: Provides a clear, easily scannable summary of all key nutritional targets, offering necessary detail without complexity. Library: HTML/CSS.
        - Report Info: Complete daily meal plan. Goal: Organize/Action. Viz/Method: A series of "meal-card" components, organized by mealtime (breakfast, lunch, etc.), listing specific foods and quantities. Interaction: Hyperlinks on food items to an e-commerce site. Justification: Translates abstract data into a concrete, actionable plan. The external links add immediate utility, bridging the gap from planning to execution. Library: HTML/CSS.
        - Report Info: Aggregated list of all ingredients. Goal: Organize/Action. Viz/Method: A categorized "shopping list" card that groups all necessary ingredients. Interaction: Hyperlinks on each ingredient. Justification: Solves the user's next logical problem ("What do I need to buy?"), significantly increasing the tool's practical value and stickiness. Library: HTML/CSS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mealStack - ë§ì¶¤í˜• ë‹¨ë°±ì§ˆ ê³„ì‚°ê¸°</title>
    <meta
      name="description"
      content="ë‹¹ì‹ ì˜ ì²´í˜• ëª©í‘œì— ë§ëŠ” ì™„ë²½í•œ ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ê³¼ ì‹ë‹¨ì„ ì œê³µí•©ë‹ˆë‹¤. ë²Œí¬ì—…, ë¦°ë²Œí¬ì—…, ì»·íŒ…, ìœ ì§€ ëª©ì ë³„ ë§ì¶¤ ì‹ë‹¨ ê³„ì‚°ê¸°"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --primary-red: #dc2626;
        --dark-bg: #1a1a1a;
        --card-bg: #2d2d2d;
        --text-light: #f8f9fa;
        --border-color: #404040;
      }
      body {
        background-color: var(--dark-bg);
        color: var(--text-light);
        font-family: "Pretendard", "Arial", sans-serif;
      }
      .input-card, .meal-card, .subscription-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
      }
      .hero-title {
        background: linear-gradient(45deg, var(--primary-red), #ff4d4d);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .btn-primary {
        background: linear-gradient(45deg, var(--primary-red), #ff4d4d);
        border: none;
      }
      .btn-primary:hover {
        background: linear-gradient(45deg, #b91c1c, var(--primary-red));
      }
      .form-control, .form-select {
        background-color: #1a1a1a;
        color: var(--text-light);
      }
      .form-control:focus, .form-select:focus {
        border-color: var(--primary-red);
        box-shadow: 0 0 0 0.25rem rgba(220, 38, 38, 0.25);
        background-color: #1a1a1a;
        color: var(--text-light);
      }
      #mainProteinCard {
        background: linear-gradient(135deg, var(--primary-red), #ff4d4d, #dc2626) !important;
        border: 3px solid #fff !important;
        box-shadow: 0 20px 50px rgba(220, 38, 38, 0.6), 0 0 30px rgba(220, 38, 38, 0.3);
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      .preference-checkbox input[type="checkbox"]:checked + label {
        background: var(--primary-red);
        border-color: var(--primary-red);
        color: white;
      }
    </style>
  </head>
  <body class="bg-dark-bg text-text-light">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background: rgba(26, 26, 26, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color);">
      <div class="container">
        <a class="navbar-brand text-2xl font-bold text-primary-red" href="#">
          <i class="fas fa-dumbbell"></i> mealStack
        </a>
      </div>
    </nav>

    <section class="text-center py-20">
      <div class="container">
        <h1 class="hero-title text-6xl font-black mb-4">ë§ì¶¤í˜• ë‹¨ë°±ì§ˆ ì‹ë‹¨ ê³„ì‚°ê¸°</h1>
        <p class="text-lg text-gray-300 mb-8">
          ë‹¹ì‹ ì˜ ì²´í˜• ëª©í‘œì— ë§ëŠ” ì™„ë²½í•œ ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ê³¼ ì‹ë‹¨ì„ ì œê³µí•©ë‹ˆë‹¤
        </p>
      </div>
    </section>

    <section class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="input-card rounded-xl p-8 mb-8 shadow-lg">
            <h3 class="text-center mb-4 text-xl"><i class="fas fa-calculator text-danger"></i> ê³„ì‚° ì‹œì‘í•˜ê¸°</h3>
            <form id="proteinForm">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">ëª¸ë¬´ê²Œ (kg)</label>
                  <input type="number" class="form-control bg-dark-bg border-2 border-border-color text-text-light rounded-lg p-3" id="weight" min="40" max="150" placeholder="70" required />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">ì²´í˜• ëª©í‘œ</label>
                  <select class="form-select bg-dark-bg border-2 border-border-color text-text-light rounded-lg p-3" id="goal" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="bulkup">ë²Œí¬ì—… (ê·¼ìœ¡ ì¦ê°€)</option>
                    <option value="lean_bulkup">ë¦°ë²Œí¬ì—… (ê¹”ë”í•œ ì¦ëŸ‰)</option>
                    <option value="cutting">ì»·íŒ… (ì²´ì§€ë°© ê°ì†Œ)</option>
                    <option value="maintain">ìœ ì§€ (í˜„ìƒ ìœ ì§€)</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">ìš´ë™ íšŸìˆ˜</label>
                  <select class="form-select bg-dark-bg border-2 border-border-color text-text-light rounded-lg p-3" id="activity" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="low">ë‚®ìŒ (ì£¼ 3íšŒ ì´í•˜)</option>
                    <option value="moderate">ë³´í†µ (ì£¼ 4-5íšŒ)</option>
                    <option value="high">ë†’ìŒ (ì£¼ 6íšŒ ì´ìƒ)</option>
                  </select>
                </div>
              </div>
              <div class="p-4 my-4 rounded-xl" style="background: rgba(45, 45, 45, 0.5); border: 1px solid var(--border-color);">
                <h5 class="mb-3 text-center">ì„ í˜¸í•˜ëŠ” ì‹í’ˆ ì¢…ë¥˜ <small class="text-gray-400 block">(ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</small></h5>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                  <div class="preference-checkbox">
                    <input type="checkbox" id="meat" value="meat" checked /><label for="meat" class="inline-block bg-card-bg text-text-light px-6 py-3 border-2 border-border-color rounded-full cursor-pointer transition-all duration-300 font-medium whitespace-nowrap"><i class="fas fa-drumstick-bite"></i> ìœ¡ë¥˜</label>
                  </div>
                  <div class="preference-checkbox">
                    <input type="checkbox" id="seafood" value="seafood" checked /><label for="seafood" class="inline-block bg-card-bg text-text-light px-6 py-3 border-2 border-border-color rounded-full cursor-pointer transition-all duration-300 font-medium whitespace-nowrap"><i class="fas fa-fish"></i> ì–´ë¥˜/í•´ì‚°ë¬¼</label>
                  </div>
                  <div class="preference-checkbox">
                    <input type="checkbox" id="plant" value="plant" checked /><label for="plant" class="inline-block bg-card-bg text-text-light px-6 py-3 border-2 border-border-color rounded-full cursor-pointer transition-all duration-300 font-medium whitespace-nowrap"><i class="fas fa-leaf"></i> ì‹ë¬¼ì„±</label>
                  </div>
                </div>
              </div>
              <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg rounded-full font-bold uppercase tracking-wider py-3 px-8 transition-all duration-300 hover:translate-y-[-2px] hover:shadow-lg hover:shadow-red-500/50">
                  <i class="fas fa-bolt"></i> ë‹¨ë°±ì§ˆ ì–‘ ê³„ì‚°í•˜ê¸°
                </button>
              </div>
            </form>
          </div>
          <div id="mainProteinCard" class="text-center rounded-3xl p-8 my-6" style="display: none;">
            <div class="text-7xl font-black text-white" id="mainProteinAmount" style="text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);">0</div>
            <div class="text-xl font-bold uppercase tracking-widest text-white/90 mt-2">ì¼ì¼ ê¶Œì¥ ë‹¨ë°±ì§ˆ</div>
          </div>
          <div class="text-center my-8" id="captureSection" style="display: none">
            <button class="btn-primary rounded-full font-bold uppercase tracking-wider py-3 px-6 m-2 transition-all duration-300 hover:translate-y-[-2px] hover:shadow-lg hover:shadow-red-500/50" onclick="captureResult()">
              <i class="fas fa-camera"></i> ğŸ“‹ ì‹ë‹¨í‘œ ì´ë¯¸ì§€ë¡œ ì €ì¥
            </button>
            <button class="btn-primary rounded-full font-bold uppercase tracking-wider py-3 px-6 m-2 transition-all duration-300 hover:translate-y-[-2px] hover:shadow-lg hover:shadow-red-500/50" onclick="shareResult()">
              <i class="fas fa-share"></i> ê²°ê³¼ ê³µìœ í•˜ê¸°
            </button>
          </div>
        </div>
      </div>
    </section>

    <div class="container">
      <div class="text-center my-8" id="loading" style="display: none;">
        <i class="fas fa-spinner fa-spin fa-3x text-danger"></i>
        <p class="mt-3">ìµœì ì˜ ì‹ë‹¨ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>

    <section class="container" id="resultSectionWrapper" style="display: none">
        <div id="resultSection" class="input-card rounded-xl p-8 mb-8 shadow-lg">
             <h5 class="text-center text-primary-red text-2xl mb-6 font-bold"><i class="fas fa-chart-pie"></i> ëª©í‘œ ì˜ì–‘ì†Œ</h5>
             <div id="goalDescription" class="text-center text-gray-300 mb-6"></div>
             <div id="nutritionBreakdown" class="text-center"></div>
        </div>
    </section>

    <section class="container" id="mealPlansSection" style="display: none">
      <h2 class="text-4xl font-bold text-center my-12 text-primary-red"><i class="fas fa-utensils"></i> ì¶”ì²œ ì‹ë‹¨</h2>
      <div id="mealPlans"></div>
    </section>

    <footer class="text-center py-5 mt-5" style="border-top: 1px solid var(--border-color)">
      <div class="container">
        <p class="text-gray-400">
          Â© 2025 mealStack. ê±´ê°•í•œ ë‹¨ë°±ì§ˆ ë¼ì´í”„ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
        </p>
      </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        let lastCalculationResult = null;

        const scientificMealData = {
            bulkup: { description: "ê·¼ìœ¡ëŸ‰ ì¦ê°€ë¥¼ ìœ„í•œ ê³ ë‹¨ë°± ì‹ë‹¨", proteinPerKg: 2.2, calorieMultiplier: 1.15, carbRatio: 0.6, proteinRatio: 0.3, fatRatio: 0.1, meals: { breakfast: { name: "ë²Œí¬ì—… ì•„ì¹¨", foods: [{ name: "ê³„ë€", amount: "3ê°œ", protein: 19.5, carb: 1.5, fat: 15.0, baseAmount: 3, unit: "ê°œ" }, { name: "í˜„ë¯¸ë°¥", amount: "80g", protein: 6.3, carb: 58.0, fat: 2.2, baseAmount: 80, unit: "g" }, { name: "ë°”ë‚˜ë‚˜", amount: "1ê°œ", protein: 1.1, carb: 23.0, fat: 0.3, baseAmount: 1, unit: "ê°œ" }, { name: "ê²¬ê³¼ë¥˜", amount: "20g", protein: 4.0, carb: 4.0, fat: 12.0, baseAmount: 20, unit: "g" }] }, lunch: { name: "ë²Œí¬ì—… ì ì‹¬", foods: [{ name: "ë‹­ê°€ìŠ´ì‚´", amount: "200g", protein: 62.0, carb: 0, fat: 2.0, baseAmount: 200, unit: "g" }, { name: "í˜„ë¯¸ë°¥", amount: "120g", protein: 9.5, carb: 87.0, fat: 3.3, baseAmount: 120, unit: "g" }, { name: "ë¸Œë¡œì½œë¦¬", amount: "100g", protein: 2.8, carb: 7.0, fat: 0.4, baseAmount: 100, unit: "g" }, { name: "ì˜¬ë¦¬ë¸Œì˜¤ì¼", amount: "10g", protein: 0, carb: 0, fat: 10.0, baseAmount: 10, unit: "g" }] }, dinner: { name: "ë²Œí¬ì—… ì €ë…", foods: [{ name: "ì—°ì–´", amount: "180g", protein: 45.0, carb: 0, fat: 24.0, baseAmount: 180, unit: "g" }, { name: "ê³ êµ¬ë§ˆ", amount: "150g", protein: 3.0, carb: 30.0, fat: 0.2, baseAmount: 150, unit: "g" }, { name: "ì‹œê¸ˆì¹˜", amount: "100g", protein: 2.9, carb: 2.0, fat: 0.4, baseAmount: 100, unit: "g" }] }, snack: { name: "ë²Œí¬ì—… ê°„ì‹", foods: [{ name: "ì›¨ì´ í”„ë¡œí‹´", amount: "35g", protein: 28.0, carb: 3.0, fat: 1.5, baseAmount: 35, unit: "g" }, { name: "ì˜¤íŠ¸ë°€", amount: "40g", protein: 5.4, carb: 24.0, fat: 2.4, baseAmount: 40, unit: "g" }] } } },
            lean_bulkup: { description: "ì²´ì§€ë°© ì¦ê°€ ìµœì†Œí™”í•˜ë©° ê·¼ìœ¡ëŸ‰ ì¦ê°€", proteinPerKg: 1.9, calorieMultiplier: 1.08, carbRatio: 0.5, proteinRatio: 0.3, fatRatio: 0.2, meals: { breakfast: { name: "ë¦°ë²Œí¬ì—… ì•„ì¹¨", foods: [{ name: "ê³„ë€í°ì", amount: "4ê°œ", protein: 14.0, carb: 0.8, fat: 0.2, baseAmount: 4, unit: "ê°œ" }, { name: "í†µë°€ë¹µ", amount: "2ì¥", protein: 6.0, carb: 24.0, fat: 2.0, baseAmount: 2, unit: "ì¥" }, { name: "ì•„ë³´ì¹´ë„", amount: "50g", protein: 1.0, carb: 4.0, fat: 7.5, baseAmount: 50, unit: "g" }] }, lunch: { name: "ë¦°ë²Œí¬ì—… ì ì‹¬", foods: [{ name: "ë‹­ê°€ìŠ´ì‚´", amount: "180g", protein: 55.8, carb: 0, fat: 1.8, baseAmount: 180, unit: "g" }, { name: "í€´ë…¸ì•„", amount: "70g", protein: 9.9, carb: 40.0, fat: 4.2, baseAmount: 70, unit: "g" }, { name: "ì±„ì†ŒìƒëŸ¬ë“œ", amount: "150g", protein: 3.0, carb: 8.0, fat: 0.3, baseAmount: 150, unit: "g" }] }, dinner: { name: "ë¦°ë²Œí¬ì—… ì €ë…", foods: [{ name: "í°ì‚´ìƒì„ ", amount: "160g", protein: 35.2, carb: 0, fat: 1.6, baseAmount: 160, unit: "g" }, { name: "í˜„ë¯¸ë°¥", amount: "60g", protein: 4.7, carb: 43.5, fat: 1.7, baseAmount: 60, unit: "g" }, { name: "ë¸Œë¡œì½œë¦¬", amount: "120g", protein: 3.4, carb: 8.4, fat: 0.5, baseAmount: 120, unit: "g" }] }, snack: { name: "ë¦°ë²Œí¬ì—… ê°„ì‹", foods: [{ name: "ê·¸ë¦­ìš”ê±°íŠ¸", amount: "150g", protein: 15.0, carb: 9.0, fat: 0.75, baseAmount: 150, unit: "g" }, { name: "ë² ë¦¬ë¥˜", amount: "80g", protein: 0.6, carb: 12.0, fat: 0.2, baseAmount: 80, unit: "g" }] } } },
            cutting: { description: "ê·¼ìœ¡ëŸ‰ ë³´ì¡´í•˜ë©° ì²´ì§€ë°© ê°ì†Œ", proteinPerKg: 2.4, calorieMultiplier: 0.85, carbRatio: 0.4, proteinRatio: 0.4, fatRatio: 0.2, meals: { breakfast: { name: "ì»·íŒ… ì•„ì¹¨", foods: [{ name: "ê³„ë€í°ì", amount: "5ê°œ", protein: 17.5, carb: 1.0, fat: 0.25, baseAmount: 5, unit: "ê°œ" }, { name: "ì˜¤íŠ¸ë°€", amount: "30g", protein: 4.0, carb: 18.0, fat: 1.8, baseAmount: 30, unit: "g" }, { name: "ì‹œê¸ˆì¹˜", amount: "100g", protein: 2.9, carb: 2.0, fat: 0.4, baseAmount: 100, unit: "g" }] }, lunch: { name: "ì»·íŒ… ì ì‹¬", foods: [{ name: "ë‹­ê°€ìŠ´ì‚´", amount: "200g", protein: 62.0, carb: 0, fat: 2.0, baseAmount: 200, unit: "g" }, { name: "í˜„ë¯¸ë°¥", amount: "40g", protein: 3.2, carb: 29.0, fat: 1.1, baseAmount: 40, unit: "g" }, { name: "ì±„ì†Œë¯¹ìŠ¤", amount: "200g", protein: 4.0, carb: 10.0, fat: 0.4, baseAmount: 200, unit: "g" }] }, dinner: { name: "ì»·íŒ… ì €ë…", foods: [{ name: "í°ì‚´ìƒì„ ", amount: "180g", protein: 39.6, carb: 0, fat: 1.8, baseAmount: 180, unit: "g" }, { name: "ë¸Œë¡œì½œë¦¬", amount: "200g", protein: 5.6, carb: 14.0, fat: 0.8, baseAmount: 200, unit: "g" }] }, snack: { name: "ì»·íŒ… ê°„ì‹", foods: [{ name: "ì¹´ì œì¸ í”„ë¡œí‹´", amount: "30g", protein: 24.0, carb: 2.0, fat: 1.0, baseAmount: 30, unit: "g" }] } } },
            maintain: { description: "í˜„ì¬ ì²´í˜• ë° ê±´ê°• ìœ ì§€", proteinPerKg: 1.6, calorieMultiplier: 1.0, carbRatio: 0.5, proteinRatio: 0.3, fatRatio: 0.2, meals: { breakfast: { name: "ìœ ì§€ ì•„ì¹¨", foods: [{ name: "ê³„ë€", amount: "2ê°œ", protein: 13.0, carb: 1.0, fat: 10.0, baseAmount: 2, unit: "ê°œ" }, { name: "í†µë°€ë¹µ", amount: "2ì¥", protein: 6.0, carb: 24.0, fat: 2.0, baseAmount: 2, unit: "ì¥" }, { name: "ì•„ëª¬ë“œ", amount: "15g", protein: 3.0, carb: 3.0, fat: 7.5, baseAmount: 15, unit: "g" }] }, lunch: { name: "ìœ ì§€ ì ì‹¬", foods: [{ name: "ë‹­ê°€ìŠ´ì‚´", amount: "150g", protein: 46.5, carb: 0, fat: 1.5, baseAmount: 150, unit: "g" }, { name: "í˜„ë¯¸ë°¥", amount: "80g", protein: 6.3, carb: 58.0, fat: 2.2, baseAmount: 80, unit: "g" }, { name: "ì±„ì†ŒìƒëŸ¬ë“œ", amount: "120g", protein: 3.0, carb: 8.0, fat: 0.5, baseAmount: 120, unit: "g" }] }, dinner: { name: "ìœ ì§€ ì €ë…", foods: [{ name: "ë‘ë¶€", amount: "150g", protein: 12.0, carb: 4.5, fat: 6.0, baseAmount: 150, unit: "g" }, { name: "í˜„ë¯¸ë°¥", amount: "60g", protein: 4.7, carb: 43.5, fat: 1.7, baseAmount: 60, unit: "g" }] }, snack: { name: "ìœ ì§€ ê°„ì‹", foods: [{ name: "ê·¸ë¦­ìš”ê±°íŠ¸", amount: "100g", protein: 10.0, carb: 6.0, fat: 0.5, baseAmount: 100, unit: "g" }, { name: "ì‚¬ê³¼", amount: "0.5ê°œ", protein: 0.3, carb: 13.0, fat: 0.2, baseAmount: 0.5, unit: "ê°œ" }] } } }
        };

        function getPrimaryNutrient(foodName) {
            const proteinFoods = ['ë‹­ê°€ìŠ´ì‚´', 'ì†Œê³ ê¸°', 'ë¼ì§€ê³ ê¸°', 'ì—°ì–´', 'ì°¸ì¹˜', 'í°ì‚´ìƒì„ ', 'ê³„ë€', 'ê³„ë€í°ì', 'ì›¨ì´ í”„ë¡œí‹´', 'ì¹´ì œì¸ í”„ë¡œí‹´', 'ë‘ë¶€', 'ê·¸ë¦­ìš”ê±°íŠ¸'];
            const carbFoods = ['í˜„ë¯¸ë°¥', 'í†µë°€ë¹µ', 'ê³ êµ¬ë§ˆ', 'ë°”ë‚˜ë‚˜', 'ì‚¬ê³¼', 'ì˜¤íŠ¸ë°€', 'í€´ë…¸ì•„', 'ë² ë¦¬ë¥˜'];
            const fatFoods = ['ê²¬ê³¼ë¥˜', 'ì•„ëª¬ë“œ', 'ì•„ë³´ì¹´ë„', 'ì˜¬ë¦¬ë¸Œì˜¤ì¼'];
            if (proteinFoods.includes(foodName)) return 'protein';
            if (carbFoods.includes(foodName)) return 'carb';
            if (fatFoods.includes(foodName)) return 'fat';
            return 'protein';
        }

        function balanceMealMacrosIteratively(baseMeals, targetMacros) {
            let adjustedMeals = JSON.parse(JSON.stringify(baseMeals));
            const dampeningFactor = 0.4; 
            const maxIterations = 25;

            for (let i = 0; i < maxIterations; i++) {
                let currentTotals = { protein: 0, carb: 0, fat: 0 };
                Object.values(adjustedMeals).forEach(meal => {
                    meal.foods.forEach(food => {
                        currentTotals.protein += food.protein;
                        currentTotals.carb += food.carb;
                        currentTotals.fat += food.fat;
                    });
                });

                const ratios = {
                    protein: currentTotals.protein > 0 ? targetMacros.protein / currentTotals.protein : 1,
                    carb: currentTotals.carb > 0 ? targetMacros.carbs / currentTotals.carb : 1,
                    fat: currentTotals.fat > 0 ? targetMacros.fat / currentTotals.fat : 1
                };

                if (Math.abs(ratios.protein - 1) < 0.05 && Math.abs(ratios.carb - 1) < 0.05 && Math.abs(ratios.fat - 1) < 0.05) {
                    break;
                }

                Object.values(adjustedMeals).forEach(meal => {
                    meal.foods.forEach(food => {
                        const primaryNutrient = getPrimaryNutrient(food.name);
                        let adjustmentRatio = ratios[primaryNutrient];
                        
                        const foodTotalCalories = (food.protein * 4) + (food.carb * 4) + (food.fat * 9);
                        if (foodTotalCalories > 0) {
                            const fatCalorieContribution = (food.fat * 9) / foodTotalCalories;
                            if (ratios.fat < 0.98 && fatCalorieContribution > 0.30) {
                                adjustmentRatio = (adjustmentRatio + (ratios.fat * 2)) / 3;
                            }
                        }

                        const effectiveRatio = 1 + (adjustmentRatio - 1) * dampeningFactor;

                        const originalMacrosPerBase = {
                            protein: food.protein / food.baseAmount,
                            carb: food.carb / food.baseAmount,
                            fat: food.fat / food.baseAmount
                        };

                        let newAmount = food.baseAmount * effectiveRatio;
                        newAmount = Math.max(newAmount, 1); 
                        
                        food.baseAmount = newAmount;
                        food.protein = newAmount * originalMacrosPerBase.protein;
                        food.carb = newAmount * originalMacrosPerBase.carb;
                        food.fat = newAmount * originalMacrosPerBase.fat;

                        if (food.unit === "ê°œ" || food.unit === "ì¥") {
                            food.amount = `${parseFloat(newAmount.toFixed(1))}${food.unit}`;
                        } else {
                            food.amount = `${Math.round(newAmount)}${food.unit}`;
                        }
                    });
                });
            }
            return adjustedMeals;
        }

        function calculateCalories(weight, goal, activity) {
            const age = 25;
            const height = 170;
            const bmr = 88.362 + 13.397 * weight + 4.799 * height - 5.677 * age;
            const activityMultipliers = { low: 1.375, moderate: 1.55, high: 1.725 };
            const tdee = bmr * activityMultipliers[activity];
            const goalMultiplier = scientificMealData[goal].calorieMultiplier;
            return Math.round(tdee * goalMultiplier);
        }

        function calculateMacros(totalCalories, goal) {
            const data = scientificMealData[goal];
            const proteinCalories = totalCalories * data.proteinRatio;
            const carbCalories = totalCalories * data.carbRatio;
            const fatCalories = totalCalories * data.fatRatio;
            return {
                protein: Math.round(proteinCalories / 4),
                carbs: Math.round(carbCalories / 4),
                fat: Math.round(fatCalories / 9),
                totalCalories: totalCalories
            };
        }

        document.getElementById("proteinForm").addEventListener("submit", function (e) {
            e.preventDefault();
            calculateAndDisplay();
        });

        function calculateAndDisplay() {
            const weight = parseFloat(document.getElementById("weight").value);
            const goal = document.getElementById("goal").value;
            const activity = document.getElementById("activity").value;
            if (!weight || !goal || !activity) { alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            const preferences = Array.from(document.querySelectorAll('.preference-checkbox input:checked')).map(el => el.value);
            if (preferences.length === 0) { alert("ì ì–´ë„ í•˜ë‚˜ì˜ ì‹í’ˆ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            document.getElementById("loading").style.display = "block";
            ['resultSectionWrapper', 'mealPlansSection', 'mainProteinCard', 'captureSection'].forEach(id => document.getElementById(id).style.display = 'none');

            setTimeout(() => {
                const goalData = scientificMealData[goal];
                const totalCalories = calculateCalories(weight, goal, activity);
                const macros = calculateMacros(totalCalories, goal);
                const totalProtein = Math.round(weight * goalData.proteinPerKg);
                macros.protein = totalProtein; 

                lastCalculationResult = {
                    protein: totalProtein,
                    goal,
                    preferences,
                    description: goalData.description,
                    calories: totalCalories,
                    macros,
                    weight,
                    activity
                };

                document.getElementById("loading").style.display = "none";
                displayResults(lastCalculationResult);
                document.getElementById("mainProteinCard").style.display = "block";
                document.getElementById("mainProteinAmount").textContent = totalProtein + "g";
                document.getElementById("captureSection").style.display = "block";
            }, 1500);
        }

        function displayResults(result) {
            const { protein, goal, description, calories, macros } = result;
            
            document.getElementById("goalDescription").textContent = description;
            
            document.getElementById("nutritionBreakdown").innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-red-500/20 p-4 rounded-lg border border-red-500">
                        <div class="font-bold text-white">ğŸ’ª í•„ìš” ë‹¨ë°±ì§ˆ</div>
                        <div class="text-2xl font-black text-white">${protein}g</div>
                    </div>
                    <div class="bg-gray-500/20 p-4 rounded-lg">
                        <div class="font-bold text-white">ğŸ”¥ í•„ìš” ì¹¼ë¡œë¦¬</div>
                        <div class="text-2xl font-black text-white">${calories}kcal</div>
                    </div>
                    <div class="bg-gray-500/20 p-4 rounded-lg">
                        <div class="font-bold text-white">ğŸš í•„ìš” íƒ„ìˆ˜í™”ë¬¼</div>
                        <div class="text-2xl font-black text-white">${macros.carbs}g</div>
                    </div>
                    <div class="bg-gray-500/20 p-4 rounded-lg">
                        <div class="font-bold text-white">ğŸ¥‘ í•„ìš” ì§€ë°©</div>
                        <div class="text-2xl font-black text-white">${macros.fat}g</div>
                    </div>
                </div>
            `;

            document.getElementById("resultSectionWrapper").style.display = "block";
            document.getElementById("resultSectionWrapper").scrollIntoView({ behavior: "smooth", block: "start" });
            displayScientificMealPlans(result);
        }
        
        function getCategoryByFood(foodName) {
            const categories = {
                'ë‹¨ë°±ì§ˆ': ['ë‹­ê°€ìŠ´ì‚´', 'ì†Œê³ ê¸°', 'ë¼ì§€ê³ ê¸°', 'ì—°ì–´', 'ì°¸ì¹˜', 'í°ì‚´ìƒì„ ', 'ê³„ë€', 'ê³„ë€í°ì', 'ì›¨ì´ í”„ë¡œí‹´', 'ì¹´ì œì¸ í”„ë¡œí‹´', 'ë‘ë¶€', 'ê·¸ë¦­ìš”ê±°íŠ¸'],
                'íƒ„ìˆ˜í™”ë¬¼': ['í˜„ë¯¸ë°¥', 'í†µë°€ë¹µ', 'ê³ êµ¬ë§ˆ', 'ë°”ë‚˜ë‚˜', 'ì‚¬ê³¼', 'ì˜¤íŠ¸ë°€', 'í€´ë…¸ì•„', 'ë² ë¦¬ë¥˜'],
                'ì±„ì†Œ': ['ë¸Œë¡œì½œë¦¬', 'ì‹œê¸ˆì¹˜', 'ì–‘ìƒì¶”', 'ì±„ì†ŒìƒëŸ¬ë“œ', 'ì±„ì†Œë¯¹ìŠ¤'],
                'ê²¬ê³¼ë¥˜': ['ê²¬ê³¼ë¥˜', 'ì•„ëª¬ë“œ', 'ì•„ë³´ì¹´ë„'],
                'ê¸°íƒ€': ['ì˜¬ë¦¬ë¸Œì˜¤ì¼']
            };
            for (const [category, foods] of Object.entries(categories)) {
                if (foods.includes(foodName)) {
                    return category;
                }
            }
            return 'ê¸°íƒ€';
        }

        function createShoppingListHtml(meals) {
            const ingredients = new Map();
            Object.values(meals).forEach(meal => {
                meal.foods.forEach(food => {
                    if (ingredients.has(food.name)) {
                        const existing = ingredients.get(food.name);
                        existing.protein += food.protein;
                        // For simplicity, we are not aggregating amounts here due to unit differences
                    } else {
                        ingredients.set(food.name, { ...food, category: getCategoryByFood(food.name) });
                    }
                });
            });

            const aggregatedIngredients = Array.from(ingredients.values());
            const categoryGroups = {};
            aggregatedIngredients.forEach(ing => {
                if (!categoryGroups[ing.category]) categoryGroups[ing.category] = [];
                categoryGroups[ing.category].push(ing);
            });

            const categoryOrder = ['ë‹¨ë°±ì§ˆ', 'íƒ„ìˆ˜í™”ë¬¼', 'ì±„ì†Œ', 'ê²¬ê³¼ë¥˜', 'ê¸°íƒ€'];
            const categoryIcons = { 'ë‹¨ë°±ì§ˆ': 'ğŸ¥©', 'íƒ„ìˆ˜í™”ë¬¼': 'ğŸš', 'ì±„ì†Œ': 'ğŸ¥¬', 'ê²¬ê³¼ë¥˜': 'ğŸ¥œ', 'ê¸°íƒ€': 'ğŸ§‚' };

            let html = `<div class="input-card rounded-xl p-8 my-8 shadow-lg">
                <h4 class="text-center text-xl mb-2 font-bold"><i class="fas fa-shopping-cart text-primary-red"></i> í•„ìš”í•œ ì‹ì¬ë£Œ ì‡¼í•‘ë¦¬ìŠ¤íŠ¸</h4>
                <p class="text-center text-gray-400 text-sm mb-8">ì•„ë˜ ì‹ì¬ë£Œë“¤ì„ í´ë¦­í•˜ë©´ ì¿ íŒ¡ì—ì„œ ë°”ë¡œ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>`;

            categoryOrder.forEach(category => {
                if (categoryGroups[category] && categoryGroups[category].length > 0) {
                    html += `<div class="mb-6"><h6 class="font-bold mb-3">${categoryIcons[category]} ${category}</h6><div class="grid grid-cols-1 md:grid-cols-3 gap-3">`;
                    categoryGroups[category].forEach(ing => {
                        const link = `https://www.coupang.com/np/search?q=${encodeURIComponent(ing.name)}&channel=user`;
                        html += `<a href="${link}" target="_blank" class="block bg-dark-bg p-3 rounded-lg border border-border-color hover:border-primary-red transition">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">${ing.name}</span>
                                <span class="bg-primary-red text-white text-xs font-bold px-2 py-1 rounded-full">ğŸ’ª ${ing.protein.toFixed(1)}g</span>
                            </div></a>`;
                    });
                    html += `</div></div>`;
                }
            });

            const totalProtein = aggregatedIngredients.reduce((sum, ing) => sum + ing.protein, 0);
            const totalItems = aggregatedIngredients.length;
            const shoppingTime = Math.ceil(totalItems / 5);

            html += `<div class="mt-8 pt-6 border-t border-border-color"><div class="grid grid-cols-3 text-center">
                <div><div class="text-gray-400 text-sm">ì´ ì‹ì¬ë£Œ ìˆ˜</div><div class="font-bold text-lg">${totalItems}ê°€ì§€</div></div>
                <div><div class="text-gray-400 text-sm">ì´ ë‹¨ë°±ì§ˆ</div><div class="font-bold text-lg">${totalProtein.toFixed(1)}g</div></div>
                <div><div class="text-gray-400 text-sm">ì˜ˆìƒ ì‡¼í•‘ì‹œê°„</div><div class="font-bold text-lg">${shoppingTime}ë¶„</div></div>
            </div></div></div>`;

            html += `<div class="input-card rounded-xl p-8 my-8 shadow-lg text-center">
                <h4 class="text-xl mb-2 font-bold">mealStack ìì²´ ì‹ë‹¨ íŒ¨í‚¤ì§€ ì˜ˆì•½ ì•ˆë‚´</h4>
                <p class="text-gray-400 mb-6">ì£¼ 7~8ë§Œì›ì˜ í•˜ë£¨ 3-4ë¼ì˜ ìì²´ ë²Œí¬ì—… ì‹ë‹¨ íŒ¨í‚¤ì§€ë¥¼ ëŸ°ì¹­í•œë‹¤ë©´ ê´€ì‹¬ ìˆìœ¼ì‹¤ê¹Œìš”?</p>
                <form id="subscriptionForm" class="flex justify-center"><input type="email" id="emailInput" class="form-control w-2/3" placeholder="your-email@example.com" required>
                <button type="submit" class="btn btn-primary ml-2"><i class="fas fa-bell"></i> ì˜ˆì•½</button></form>
                <div id="subscriptionSuccessMessage" class="text-green-400 mt-2" style="display:none;">ì˜ˆì•½ ëª…ë‹¨ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                <p class="text-gray-500 text-sm mt-4">ë˜ëŠ” SNS ì±„ë„ì„ íŒ”ë¡œìš°í•˜ê³  ì†Œì‹ì„ ë°›ì•„ë³´ì„¸ìš”!</p>
                <div class="mt-3">
                    <a href="#" aria-label="YouTube" class="text-gray-400 hover:text-white mx-3 text-3xl transition-colors"><i class="fab fa-youtube"></i></a>
                    <a href="#" aria-label="Instagram" class="text-gray-400 hover:text-white mx-3 text-3xl transition-colors"><i class="fab fa-instagram"></i></a>
                </div>
            </div>`;

            return html;
        }

        function displayScientificMealPlans(result) {
            const { goal, macros } = result;
            const mealPlansSection = document.getElementById("mealPlansSection");
            const mealPlansContainer = document.getElementById("mealPlans");

            let baseMeals = JSON.parse(JSON.stringify(scientificMealData[goal].meals));
            let adaptedMeals = balanceMealMacrosIteratively(baseMeals, macros);
            
            let html = '<div class="row">';
            let finalTotals = { protein: 0, carb: 0, fat: 0, calories: 0 };

            for (const mealData of Object.values(adaptedMeals)) {
                let mealProtein = mealData.foods.reduce((sum, food) => sum + food.protein, 0);
                let mealCarb = mealData.foods.reduce((sum, food) => sum + food.carb, 0);
                let mealFat = mealData.foods.reduce((sum, food) => sum + food.fat, 0);
                let mealCalories = mealProtein * 4 + mealCarb * 4 + mealFat * 9;

                finalTotals.protein += mealProtein;
                finalTotals.carb += mealCarb;
                finalTotals.fat += mealFat;
                finalTotals.calories += mealCalories;

                html += `<div class="col-md-6 mb-4">
                            <div class="meal-card rounded-xl p-6">
                                <h5 class="font-bold text-xl mb-4 text-white">${mealData.name}</h5>`;
                
                mealData.foods.forEach(food => {
                    const link = `https://www.coupang.com/np/search?q=${encodeURIComponent(food.name)}&channel=user`;
                    html += `<div class="flex justify-between items-center py-2">
                                <a href="${link}" target="_blank" class="text-inherit hover:text-primary-red">${food.name} (${food.amount})</a>
                                <span class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full">${food.protein.toFixed(1)}g</span>
                            </div>`;
                });

                html += `<div class="mt-4 p-4 rounded-lg" style="background-color: var(--primary-red);">
                            <div class="text-center font-bold text-white text-lg">ë‹¨ë°±ì§ˆ: ${mealProtein.toFixed(1)}g</div>
                            <div class="text-center text-sm text-white/80 mt-1">
                                íƒ„ìˆ˜í™”ë¬¼: ${mealCarb.toFixed(1)}g | ì§€ë°©: ${mealFat.toFixed(1)}g
                            </div>
                            <div class="text-center text-sm text-white/80 mt-1">
                                ${mealData.name} ì¹¼ë¡œë¦¬: ${Math.round(mealCalories)}kcal
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            html += '</div>';

            html += createTotalNutritionCard(finalTotals, macros);
            html += createShoppingListHtml(adaptedMeals);

            mealPlansContainer.innerHTML = html;
            mealPlansSection.style.display = "block";

            // Add event listener for the new subscription form
            document.getElementById("subscriptionForm").addEventListener("submit", function(e) {
                e.preventDefault();
                const email = document.getElementById("emailInput").value;
                if(email) {
                    console.log("Subscription email:", email);
                    document.getElementById("subscriptionSuccessMessage").style.display = "block";
                    setTimeout(() => {
                         document.getElementById("subscriptionSuccessMessage").style.display = "none";
                    }, 3000);
                    document.getElementById("emailInput").value = "";
                }
            });
        }

        function createTotalNutritionCard(finalTotals, targetMacros) {
            const proteinAch = Math.round((finalTotals.protein / targetMacros.protein) * 100);
            const carbAch = Math.round((finalTotals.carb / targetMacros.carbs) * 100);
            const fatAch = Math.round((finalTotals.fat / targetMacros.fat) * 100);
            const calAch = Math.round((finalTotals.calories / targetMacros.totalCalories) * 100);
            
            const getAchColor = rate => (rate >= 90 && rate <= 110) ? 'text-green-400' : (rate >= 80 && rate <= 120) ? 'text-yellow-400' : 'text-red-400';

            return `<div class="input-card rounded-xl p-8 my-8 shadow-lg border-2 border-primary-red">
                <h4 class="text-center text-primary-red text-2xl mb-6 font-bold"><i class="fas fa-check-circle"></i> ìµœì¢… ì‹ë‹¨ ìš”ì•½</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <div class="text-gray-400 text-sm">ë‹¨ë°±ì§ˆ</div>
                        <div class="text-2xl font-bold">${finalTotals.protein.toFixed(1)}g</div>
                        <div class="font-bold ${getAchColor(proteinAch)}">${proteinAch}% ë‹¬ì„±</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">íƒ„ìˆ˜í™”ë¬¼</div>
                        <div class="text-2xl font-bold">${finalTotals.carb.toFixed(1)}g</div>
                        <div class="font-bold ${getAchColor(carbAch)}">${carbAch}% ë‹¬ì„±</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">ì§€ë°©</div>
                        <div class="text-2xl font-bold">${finalTotals.fat.toFixed(1)}g</div>
                        <div class="font-bold ${getAchColor(fatAch)}">${fatAch}% ë‹¬ì„±</div>
                    </div>
                     <div>
                        <div class="text-gray-400 text-sm">ì¹¼ë¡œë¦¬</div>
                        <div class="text-2xl font-bold">${Math.round(finalTotals.calories)}kcal</div>
                        <div class="font-bold ${getAchColor(calAch)}">${calAch}% ë‹¬ì„±</div>
                    </div>
                </div>
            </div>`;
        }

        window.captureResult = function () {
            const mealPlansSection = document.getElementById('mealPlansSection');
            if (!lastCalculationResult || !mealPlansSection) { alert("ë¨¼ì € ê³„ì‚°ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”."); return; }
            alert("ì‹ë‹¨í‘œë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");
            html2canvas(mealPlansSection, { backgroundColor: "#1a1a1a", scale: 1.5 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `mealStack_plan_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }).catch(err => {
                console.error("ìº¡ì²˜ ì˜¤ë¥˜:", err);
                alert("ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        };

        window.shareResult = function () {
            if (!lastCalculationResult) return;
            const { protein, goal, calories } = lastCalculationResult;
            const goalKorean = document.querySelector(`#goal option[value=${goal}]`).textContent;
            const shareText = `ğŸ”¥ ë‚˜ì˜ ë§ì¶¤ ì‹ë‹¨ ê²°ê³¼!\n\nğŸ’ª ë‹¨ë°±ì§ˆ: ${protein}g\nğŸ¯ ëª©í‘œ: ${goalKorean}\nğŸ“Š ì¹¼ë¡œë¦¬: ${calories}kcal\n\nmealStackì—ì„œ ë‹¹ì‹ ë§Œì˜ ì™„ë²½í•œ ì‹ë‹¨ì„ ì°¾ì•„ë³´ì„¸ìš”!`;
            if (navigator.share) {
                navigator.share({ title: 'mealStack ë§ì¶¤ ì‹ë‹¨ ê²°ê³¼', text: shareText, url: window.location.href });
            } else {
                navigator.clipboard.writeText(`${shareText}\n${window.location.href}`).then(() => alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'));
            }
        };
    });
    </script>
  </body>
</html>
