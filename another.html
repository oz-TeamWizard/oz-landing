<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mealStack - ë§ì¶¤í˜• ë‹¨ë°±ì§ˆ ê³„ì‚°ê¸°</title>
    <meta
      name="description"
      content="ë‹¹ì‹ ì˜ ì²´í˜• ëª©í‘œì— ë§ëŠ” ì™„ë²½í•œ ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ê³¼ ì‹ë‹¨ì„ ì œê³µí•©ë‹ˆë‹¤. ë²Œí¬ì—…, ë¦°ë²Œí¬ì—…, ì»·íŒ…, ìœ ì§€ ëª©ì ë³„ ë§ì¶¤ ì‹ë‹¨ ê³„ì‚°ê¸°"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap");
      :root {
        --primary-red: #dc2626;
        --dark-bg: #111111;
        --card-bg: rgba(38, 38, 38, 0.6);
        --text-light: #f0f0f0;
        --border-color: rgba(255, 255, 255, 0.1);
      }
      .text-primary-red {
        color: var(--primary-red) !important;
      }
      body {
        background-color: var(--dark-bg);
        background-image: radial-gradient(
            circle at 10% 10%,
            rgba(220, 38, 38, 0.1) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(220, 38, 38, 0.08) 0%,
            transparent 50%
          );
        color: var(--text-light);
        font-family: "Inter", "Pretendard", sans-serif;
      }
      .navbar {
        background: rgba(17, 17, 17, 0.75) !important;
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border-color);
      }
      .hero-title {
        background: linear-gradient(45deg, #ef4444, #f87171);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 40px rgba(239, 68, 68, 0.3);
      }
      .hero-subtitle {
        color: #a0a0a0;
      }
      .input-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 1.25rem;
        backdrop-filter: blur(12px);
        transition: transform 0.3s ease, box-shadow 0.3s ease,
          border-color 0.3s ease;
      }
      .input-card:hover {
        transform: translateY(-8px);
        border-color: rgba(220, 38, 38, 0.5);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4),
          0 0 30px rgba(220, 38, 38, 0.2);
      }
      .btn-primary {
        background: linear-gradient(45deg, var(--primary-red), #ef4444);
        border: none;
        border-radius: 9999px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .btn-primary:hover {
        transform: translateY(-3px) scale(1.03);
        box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4),
          0 0 25px rgba(239, 68, 68, 0.3);
      }
      .form-control,
      .form-select {
        background-color: rgba(17, 17, 17, 0.8);
        color: var(--text-light);
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
        padding: 0.9rem 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-red);
        box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
        background-color: rgba(17, 17, 17, 0.9);
        color: var(--text-light);
      }
      #mainProteinCard {
        background: linear-gradient(135deg, #ef4444, #dc2626) !important;
        border: 2px solid rgba(255, 255, 255, 0.8) !important;
        box-shadow: 0 20px 50px rgba(220, 38, 38, 0.5),
          0 0 30px rgba(220, 38, 38, 0.3);
        animation: pulse 2.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 20px 50px rgba(220, 38, 38, 0.5),
            0 0 30px rgba(220, 38, 38, 0.3);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 25px 60px rgba(239, 68, 68, 0.6),
            0 0 45px rgba(239, 68, 68, 0.4);
        }
      }
      .preference-label.selected {
        background: var(--primary-red);
        border-color: var(--primary-red);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
      }
      .preference-label {
        transition: all 0.3s ease;
      }

      /* ì»¤ìŠ¤í…€ ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ */
      .custom-accordion-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 1.25rem;
        backdrop-filter: blur(12px);
        margin-bottom: 1rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease,
          border-color 0.3s ease;
      }

      .custom-accordion-item:hover {
        transform: translateY(-8px);
        border-color: rgba(220, 38, 38, 0.5);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4),
          0 0 30px rgba(220, 38, 38, 0.2);
      }

      .custom-accordion-header {
        padding: 1rem 1.25rem;
        cursor: pointer;
        border-radius: 1.25rem;
        background: transparent;
        color: var(--text-light);
        font-weight: 700;
        font-size: 1.1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: all 0.3s ease;
      }

      .custom-accordion-header.active {
        background: linear-gradient(45deg, var(--primary-red), #ef4444);
        color: white;
        border-radius: 1.25rem 1.25rem 0 0;
      }

      .custom-accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background-color: var(--card-bg);
        border-radius: 0 0 1.25rem 1.25rem;
      }

      .custom-accordion-content.active {
        max-height: 1000px;
      }

      .custom-accordion-body {
        padding: 1rem 1.25rem;
        color: var(--text-light);
      }

      .accordion-icon {
        transition: transform 0.3s ease;
      }

      .accordion-icon.rotated {
        transform: rotate(180deg);
      }

      /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
      .loading-spinner {
        border: 3px solid rgba(220, 38, 38, 0.3);
        border-radius: 50%;
        border-top: 3px solid var(--primary-red);
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ì•Œë¦¼ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
      .alert-success {
        background-color: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #22c55e;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
      }

      .alert-error {
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
      }

      .alert-info {
        background-color: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: #3b82f6;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body class="bg-dark-bg text-text-light">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand text-2xl font-bold text-primary-red" href="#">
          <i class="fas fa-dumbbell"></i> mealStack
        </a>
      </div>
    </nav>

    <section class="text-center py-20">
      <div class="container">
        <h1 class="hero-title text-6xl font-black mb-4">
          ë§ì¶¤í˜• ë‹¨ë°±ì§ˆ ì‹ë‹¨ ê³„ì‚°ê¸°
        </h1>
        <p class="hero-subtitle text-lg mb-8">
          ë‹¹ì‹ ì˜ ì²´í˜• ëª©í‘œì— ë§ëŠ” ì™„ë²½í•œ ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ê³¼ ì‹ë‹¨ì„ ì œê³µí•©ë‹ˆë‹¤
        </p>
      </div>
    </section>

    <section class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="input-card p-8 mb-8 shadow-lg">
            <h3 class="text-center mb-4 text-xl">
              <i class="fas fa-calculator text-danger"></i> ê³„ì‚° ì‹œì‘í•˜ê¸°
            </h3>
            <form id="proteinForm">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">ëª¸ë¬´ê²Œ (kg)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="weight"
                    min="40"
                    max="150"
                    placeholder="70"
                    required
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">ì²´í˜• ëª©í‘œ</label>
                  <select class="form-select" id="goal" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="bulkup">ë²Œí¬ì—… (ê·¼ìœ¡ ì¦ê°€)</option>
                    <option value="lean_bulkup">ë¦°ë²Œí¬ì—… (ê¹”ë”í•œ ì¦ëŸ‰)</option>
                    <option value="cutting">ì»·íŒ… (ì²´ì§€ë°© ê°ì†Œ)</option>
                    <option value="maintain">ìœ ì§€ (í˜„ìƒ ìœ ì§€)</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">ìš´ë™ íšŸìˆ˜</label>
                  <select class="form-select" id="activity" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="low">ë‚®ìŒ (ì£¼ 3íšŒ ì´í•˜)</option>
                    <option value="moderate">ë³´í†µ (ì£¼ 4-5íšŒ)</option>
                    <option value="high">ë†’ìŒ (ì£¼ 6íšŒ ì´ìƒ)</option>
                  </select>
                </div>
              </div>
              <div
                class="p-4 my-4 rounded-xl"
                style="
                  background: rgba(0, 0, 0, 0.2);
                  border: 1px solid var(--border-color);
                "
              >
                <h5 class="mb-3 text-center">
                  ì„ í˜¸í•˜ëŠ” ì‹í’ˆ ì¢…ë¥˜
                  <small class="text-gray-400 block">(ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</small>
                </h5>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                  <label
                    data-value="meat"
                    class="preference-label selected inline-block bg-card-bg text-text-light px-6 py-3 border-2 border-border-color rounded-full cursor-pointer font-medium whitespace-nowrap"
                    ><i class="fas fa-drumstick-bite"></i> ìœ¡ë¥˜</label
                  >
                  <label
                    data-value="seafood"
                    class="preference-label selected inline-block bg-card-bg text-text-light px-6 py-3 border-2 border-border-color rounded-full cursor-pointer font-medium whitespace-nowrap"
                    ><i class="fas fa-fish"></i> ì–´ë¥˜/í•´ì‚°ë¬¼</label
                  >
                  <label
                    data-value="plant"
                    class="preference-label selected inline-block bg-card-bg text-text-light px-6 py-3 border-2 border-border-color rounded-full cursor-pointer font-medium whitespace-nowrap"
                    ><i class="fas fa-leaf"></i> ì‹ë¬¼ì„±</label
                  >
                </div>
              </div>
              <div class="text-center">
                <button
                  type="submit"
                  class="btn btn-primary btn-lg font-bold uppercase tracking-wider py-3 px-8"
                >
                  <i class="fas fa-bolt"></i> ë‹¨ë°±ì§ˆ ì–‘ ê³„ì‚°í•˜ê¸°
                </button>
              </div>
            </form>
          </div>
          <div
            id="mainProteinCard"
            class="text-center rounded-3xl p-8 my-6"
            style="display: none"
          >
            <div
              class="text-7xl font-black text-white"
              id="mainProteinAmount"
              style="text-shadow: 0 0 30px rgba(255, 255, 255, 0.8)"
            >
              0
            </div>
            <div
              class="text-xl font-bold uppercase tracking-widest text-white/90 mt-2"
            >
              ì¼ì¼ ê¶Œì¥ ë‹¨ë°±ì§ˆ
            </div>
          </div>
          <div
            class="text-center my-8"
            id="captureSection"
            style="display: none"
          >
            <button
              class="btn btn-primary font-bold uppercase tracking-wider py-3 px-6 m-2"
              onclick="captureResult()"
            >
              <i class="fas fa-camera"></i> ğŸ“‹ ì‹ë‹¨í‘œ ì´ë¯¸ì§€ë¡œ ì €ì¥
            </button>
            <button
              class="btn btn-primary font-bold uppercase tracking-wider py-3 px-6 m-2"
              onclick="shareResult()"
            >
              <i class="fas fa-share"></i> ê²°ê³¼ ê³µìœ í•˜ê¸°
            </button>
          </div>
        </div>
      </div>
    </section>

    <div class="container">
      <div class="text-center my-8" id="loading" style="display: none">
        <i class="fas fa-spinner fa-spin fa-3x text-danger"></i>
        <p class="mt-3">ìµœì ì˜ ì‹ë‹¨ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>

    <section class="container" id="resultSectionWrapper" style="display: none">
      <div id="resultSection" class="input-card p-8 mb-8 shadow-lg">
        <h5 class="text-center text-primary-red text-2xl mb-6 font-bold">
          <i class="fas fa-chart-pie"></i> ëª©í‘œ ì˜ì–‘ì†Œ
        </h5>
        <div id="goalDescription" class="text-center text-gray-400 mb-6"></div>
        <div id="nutritionBreakdown" class="text-center"></div>
      </div>
    </section>

    <section class="container" id="mealPlansSection" style="display: none">
      <h2 class="text-4xl font-bold text-center my-12 text-primary-red">
        <i class="fas fa-utensils"></i> ì¶”ì²œ ì‹ë‹¨
      </h2>
      <div id="mealPlans"></div>
    </section>

    <footer
      class="text-center py-5 mt-5"
      style="border-top: 1px solid var(--border-color)"
    >
      <div class="container">
        <p class="text-gray-500">
          Â© 2025 mealStack. ê±´ê°•í•œ ë‹¨ë°±ì§ˆ ë¼ì´í”„ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
        </p>
      </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let lastCalculationResult = null;

        // ğŸ”¥ ì‹¤ì œ ë°°í¬ URL (ì‚¬ìš©ìê°€ ì œê³µí•œ ì •í™•í•œ URL)
        const EMAIL_API_URL =
          "https://script.google.com/macros/s/AKfycbwjieEzwVqwHs8BAnE2BIrHpqaB31swH3o3u70nRfZrDa__2JoVl-86EwzBx8IwhMgm/exec";

        document.querySelectorAll(".preference-label").forEach((label) => {
          label.addEventListener("click", () => {
            label.classList.toggle("selected");
          });
        });

        const scientificMealData = {
          bulkup: {
            description: "ê·¼ìœ¡ëŸ‰ ì¦ê°€ë¥¼ ìœ„í•œ ê³ ë‹¨ë°± ì‹ë‹¨",
            proteinPerKg: 2.2,
            calorieMultiplier: 1.15,
            carbRatio: 0.6,
            proteinRatio: 0.3,
            fatRatio: 0.1,
            meals: {
              breakfast: {
                name: "ë²Œí¬ì—… ì•„ì¹¨",
                foods: [
                  {
                    name: "ê³„ë€",
                    category: "meat",
                    amount: "3ê°œ",
                    protein: 19.5,
                    carb: 1.5,
                    fat: 15.0,
                    baseAmount: 3,
                    unit: "ê°œ",
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "80g",
                    protein: 6.3,
                    carb: 58.0,
                    fat: 2.2,
                    baseAmount: 80,
                    unit: "g",
                  },
                  {
                    name: "ë°”ë‚˜ë‚˜",
                    amount: "1ê°œ",
                    protein: 1.1,
                    carb: 23.0,
                    fat: 0.3,
                    baseAmount: 1,
                    unit: "ê°œ",
                  },
                  {
                    name: "ê²¬ê³¼ë¥˜",
                    amount: "20g",
                    protein: 4.0,
                    carb: 4.0,
                    fat: 12.0,
                    baseAmount: 20,
                    unit: "g",
                  },
                ],
              },
              lunch: {
                name: "ë²Œí¬ì—… ì ì‹¬",
                foods: [
                  {
                    name: "ë‹­ê°€ìŠ´ì‚´",
                    category: "meat",
                    amount: "200g",
                    protein: 62.0,
                    carb: 0,
                    fat: 2.0,
                    baseAmount: 200,
                    unit: "g",
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "120g",
                    protein: 9.5,
                    carb: 87.0,
                    fat: 3.3,
                    baseAmount: 120,
                    unit: "g",
                  },
                  {
                    name: "ë¸Œë¡œì½œë¦¬",
                    amount: "100g",
                    protein: 2.8,
                    carb: 7.0,
                    fat: 0.4,
                    baseAmount: 100,
                    unit: "g",
                  },
                  {
                    name: "ì˜¬ë¦¬ë¸Œì˜¤ì¼",
                    amount: "10g",
                    protein: 0,
                    carb: 0,
                    fat: 10.0,
                    baseAmount: 10,
                    unit: "g",
                  },
                ],
              },
              dinner: {
                name: "ë²Œí¬ì—… ì €ë…",
                foods: [
                  {
                    name: "ì—°ì–´",
                    category: "seafood",
                    amount: "180g",
                    protein: 45.0,
                    carb: 0,
                    fat: 24.0,
                    baseAmount: 180,
                    unit: "g",
                  },
                  {
                    name: "ê³ êµ¬ë§ˆ",
                    amount: "150g",
                    protein: 3.0,
                    carb: 30.0,
                    fat: 0.2,
                    baseAmount: 150,
                    unit: "g",
                  },
                  {
                    name: "ì‹œê¸ˆì¹˜",
                    amount: "100g",
                    protein: 2.9,
                    carb: 2.0,
                    fat: 0.4,
                    baseAmount: 100,
                    unit: "g",
                  },
                ],
              },
              snack: {
                name: "ë²Œí¬ì—… ê°„ì‹",
                foods: [
                  {
                    name: "ì›¨ì´ í”„ë¡œí‹´",
                    category: "plant",
                    amount: "35g",
                    protein: 28.0,
                    carb: 3.0,
                    fat: 1.5,
                    baseAmount: 35,
                    unit: "g",
                  },
                  {
                    name: "ì˜¤íŠ¸ë°€",
                    amount: "40g",
                    protein: 5.4,
                    carb: 24.0,
                    fat: 2.4,
                    baseAmount: 40,
                    unit: "g",
                  },
                ],
              },
            },
          },
          lean_bulkup: {
            description: "ì²´ì§€ë°© ì¦ê°€ ìµœì†Œí™”í•˜ë©° ê·¼ìœ¡ëŸ‰ ì¦ê°€",
            proteinPerKg: 1.9,
            calorieMultiplier: 1.08,
            carbRatio: 0.5,
            proteinRatio: 0.3,
            fatRatio: 0.2,
            meals: {
              breakfast: {
                name: "ë¦°ë²Œí¬ì—… ì•„ì¹¨",
                foods: [
                  {
                    name: "ê³„ë€í°ì",
                    category: "meat",
                    amount: "4ê°œ",
                    protein: 14.0,
                    carb: 0.8,
                    fat: 0.2,
                    baseAmount: 4,
                    unit: "ê°œ",
                  },
                  {
                    name: "í†µë°€ë¹µ",
                    amount: "2ì¥",
                    protein: 6.0,
                    carb: 24.0,
                    fat: 2.0,
                    baseAmount: 2,
                    unit: "ì¥",
                  },
                  {
                    name: "ì•„ë³´ì¹´ë„",
                    amount: "50g",
                    protein: 1.0,
                    carb: 4.0,
                    fat: 7.5,
                    baseAmount: 50,
                    unit: "g",
                  },
                ],
              },
              lunch: {
                name: "ë¦°ë²Œí¬ì—… ì ì‹¬",
                foods: [
                  {
                    name: "ë‹­ê°€ìŠ´ì‚´",
                    category: "meat",
                    amount: "180g",
                    protein: 55.8,
                    carb: 0,
                    fat: 1.8,
                    baseAmount: 180,
                    unit: "g",
                  },
                  {
                    name: "í€´ë…¸ì•„",
                    category: "plant",
                    amount: "70g",
                    protein: 9.9,
                    carb: 40.0,
                    fat: 4.2,
                    baseAmount: 70,
                    unit: "g",
                  },
                  {
                    name: "ì±„ì†ŒìƒëŸ¬ë“œ",
                    amount: "150g",
                    protein: 3.0,
                    carb: 8.0,
                    fat: 0.3,
                    baseAmount: 150,
                    unit: "g",
                  },
                ],
              },
              dinner: {
                name: "ë¦°ë²Œí¬ì—… ì €ë…",
                foods: [
                  {
                    name: "í°ì‚´ìƒì„ ",
                    category: "seafood",
                    amount: "160g",
                    protein: 35.2,
                    carb: 0,
                    fat: 1.6,
                    baseAmount: 160,
                    unit: "g",
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "60g",
                    protein: 4.7,
                    carb: 43.5,
                    fat: 1.7,
                    baseAmount: 60,
                    unit: "g",
                  },
                  {
                    name: "ë¸Œë¡œì½œë¦¬",
                    amount: "120g",
                    protein: 3.4,
                    carb: 8.4,
                    fat: 0.5,
                    baseAmount: 120,
                    unit: "g",
                  },
                ],
              },
              snack: {
                name: "ë¦°ë²Œí¬ì—… ê°„ì‹",
                foods: [
                  {
                    name: "ê·¸ë¦­ìš”ê±°íŠ¸",
                    category: "plant",
                    amount: "150g",
                    protein: 15.0,
                    carb: 9.0,
                    fat: 0.75,
                    baseAmount: 150,
                    unit: "g",
                  },
                  {
                    name: "ë² ë¦¬ë¥˜",
                    amount: "80g",
                    protein: 0.6,
                    carb: 12.0,
                    fat: 0.2,
                    baseAmount: 80,
                    unit: "g",
                  },
                ],
              },
            },
          },
          cutting: {
            description: "ê·¼ìœ¡ëŸ‰ ë³´ì¡´í•˜ë©° ì²´ì§€ë°© ê°ì†Œ",
            proteinPerKg: 2.4,
            calorieMultiplier: 0.85,
            carbRatio: 0.4,
            proteinRatio: 0.4,
            fatRatio: 0.2,
            meals: {
              breakfast: {
                name: "ì»·íŒ… ì•„ì¹¨",
                foods: [
                  {
                    name: "ê³„ë€í°ì",
                    category: "meat",
                    amount: "5ê°œ",
                    protein: 17.5,
                    carb: 1.0,
                    fat: 0.25,
                    baseAmount: 5,
                    unit: "ê°œ",
                  },
                  {
                    name: "ì˜¤íŠ¸ë°€",
                    amount: "30g",
                    protein: 4.0,
                    carb: 18.0,
                    fat: 1.8,
                    baseAmount: 30,
                    unit: "g",
                  },
                  {
                    name: "ì‹œê¸ˆì¹˜",
                    amount: "100g",
                    protein: 2.9,
                    carb: 2.0,
                    fat: 0.4,
                    baseAmount: 100,
                    unit: "g",
                  },
                ],
              },
              lunch: {
                name: "ì»·íŒ… ì ì‹¬",
                foods: [
                  {
                    name: "ë‹­ê°€ìŠ´ì‚´",
                    category: "meat",
                    amount: "200g",
                    protein: 62.0,
                    carb: 0,
                    fat: 2.0,
                    baseAmount: 200,
                    unit: "g",
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "40g",
                    protein: 3.2,
                    carb: 29.0,
                    fat: 1.1,
                    baseAmount: 40,
                    unit: "g",
                  },
                  {
                    name: "ì±„ì†Œë¯¹ìŠ¤",
                    amount: "200g",
                    protein: 4.0,
                    carb: 10.0,
                    fat: 0.4,
                    baseAmount: 200,
                    unit: "g",
                  },
                ],
              },
              dinner: {
                name: "ì»·íŒ… ì €ë…",
                foods: [
                  {
                    name: "í°ì‚´ìƒì„ ",
                    category: "seafood",
                    amount: "180g",
                    protein: 39.6,
                    carb: 0,
                    fat: 1.8,
                    baseAmount: 180,
                    unit: "g",
                  },
                  {
                    name: "ë¸Œë¡œì½œë¦¬",
                    amount: "200g",
                    protein: 5.6,
                    carb: 14.0,
                    fat: 0.8,
                    baseAmount: 200,
                    unit: "g",
                  },
                ],
              },
              snack: {
                name: "ì»·íŒ… ê°„ì‹",
                foods: [
                  {
                    name: "ì¹´ì œì¸ í”„ë¡œí‹´",
                    category: "plant",
                    amount: "30g",
                    protein: 24.0,
                    carb: 2.0,
                    fat: 1.0,
                    baseAmount: 30,
                    unit: "g",
                  },
                ],
              },
            },
          },
          maintain: {
            description: "í˜„ì¬ ì²´í˜• ë° ê±´ê°• ìœ ì§€",
            proteinPerKg: 1.6,
            calorieMultiplier: 1.0,
            carbRatio: 0.5,
            proteinRatio: 0.3,
            fatRatio: 0.2,
            meals: {
              breakfast: {
                name: "ìœ ì§€ ì•„ì¹¨",
                foods: [
                  {
                    name: "ê³„ë€",
                    category: "meat",
                    amount: "2ê°œ",
                    protein: 13.0,
                    carb: 1.0,
                    fat: 10.0,
                    baseAmount: 2,
                    unit: "ê°œ",
                  },
                  {
                    name: "í†µë°€ë¹µ",
                    amount: "2ì¥",
                    protein: 6.0,
                    carb: 24.0,
                    fat: 2.0,
                    baseAmount: 2,
                    unit: "ì¥",
                  },
                  {
                    name: "ì•„ëª¬ë“œ",
                    amount: "15g",
                    protein: 3.0,
                    carb: 3.0,
                    fat: 7.5,
                    baseAmount: 15,
                    unit: "g",
                  },
                ],
              },
              lunch: {
                name: "ìœ ì§€ ì ì‹¬",
                foods: [
                  {
                    name: "ë‹­ê°€ìŠ´ì‚´",
                    category: "meat",
                    amount: "150g",
                    protein: 46.5,
                    carb: 0,
                    fat: 1.5,
                    baseAmount: 150,
                    unit: "g",
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "80g",
                    protein: 6.3,
                    carb: 58.0,
                    fat: 2.2,
                    baseAmount: 80,
                    unit: "g",
                  },
                  {
                    name: "ì±„ì†ŒìƒëŸ¬ë“œ",
                    amount: "120g",
                    protein: 3.0,
                    carb: 8.0,
                    fat: 0.5,
                    baseAmount: 120,
                    unit: "g",
                  },
                ],
              },
              dinner: {
                name: "ìœ ì§€ ì €ë…",
                foods: [
                  {
                    name: "ë‘ë¶€",
                    category: "plant",
                    amount: "150g",
                    protein: 12.0,
                    carb: 4.5,
                    fat: 6.0,
                    baseAmount: 150,
                    unit: "g",
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "60g",
                    protein: 4.7,
                    carb: 43.5,
                    fat: 1.7,
                    baseAmount: 60,
                    unit: "g",
                  },
                ],
              },
              snack: {
                name: "ìœ ì§€ ê°„ì‹",
                foods: [
                  {
                    name: "ê·¸ë¦­ìš”ê±°íŠ¸",
                    category: "plant",
                    amount: "100g",
                    protein: 10.0,
                    carb: 6.0,
                    fat: 0.5,
                    baseAmount: 100,
                    unit: "g",
                  },
                  {
                    name: "ì‚¬ê³¼",
                    amount: "0.5ê°œ",
                    protein: 0.3,
                    carb: 13.0,
                    fat: 0.2,
                    baseAmount: 0.5,
                    unit: "ê°œ",
                  },
                ],
              },
            },
          },
        };

        function getPrimaryNutrient(foodName) {
          const proteinFoods = [
            "ë‹­ê°€ìŠ´ì‚´",
            "ì†Œê³ ê¸°",
            "ë¼ì§€ê³ ê¸°",
            "ì—°ì–´",
            "ì°¸ì¹˜",
            "í°ì‚´ìƒì„ ",
            "ê³„ë€",
            "ê³„ë€í°ì",
            "ì›¨ì´ í”„ë¡œí‹´",
            "ì¹´ì œì¸ í”„ë¡œí‹´",
            "ë‘ë¶€",
            "ê·¸ë¦­ìš”ê±°íŠ¸",
          ];
          const carbFoods = [
            "í˜„ë¯¸ë°¥",
            "í†µë°€ë¹µ",
            "ê³ êµ¬ë§ˆ",
            "ë°”ë‚˜ë‚˜",
            "ì‚¬ê³¼",
            "ì˜¤íŠ¸ë°€",
            "í€´ë…¸ì•„",
            "ë² ë¦¬ë¥˜",
          ];
          const fatFoods = ["ê²¬ê³¼ë¥˜", "ì•„ëª¬ë“œ", "ì•„ë³´ì¹´ë„", "ì˜¬ë¦¬ë¸Œì˜¤ì¼"];
          if (proteinFoods.includes(foodName)) return "protein";
          if (carbFoods.includes(foodName)) return "carb";
          if (fatFoods.includes(foodName)) return "fat";
          return "protein";
        }

        function adaptMealsByPreference(baseMeals, preferences) {
          const adaptedMeals = JSON.parse(JSON.stringify(baseMeals));

          const foodProfiles = {
            ë‹­ê°€ìŠ´ì‚´: {
              protein: 31,
              carb: 0,
              fat: 3.6,
              unit: "g",
              category: "meat",
            },
            í°ì‚´ìƒì„ : {
              protein: 22,
              carb: 0,
              fat: 2.5,
              unit: "g",
              category: "seafood",
            },
            ë‘ë¶€: {
              protein: 8,
              carb: 1.9,
              fat: 4.8,
              unit: "g",
              category: "plant",
            },
          };

          const getReplacement = (categoryToRemove) => {
            if (categoryToRemove === "meat") {
              if (preferences.includes("seafood")) return "í°ì‚´ìƒì„ ";
              if (preferences.includes("plant")) return "ë‘ë¶€";
            }
            if (categoryToRemove === "seafood") {
              if (preferences.includes("meat")) return "ë‹­ê°€ìŠ´ì‚´";
              if (preferences.includes("plant")) return "ë‘ë¶€";
            }
            if (categoryToRemove === "plant") {
              if (preferences.includes("meat")) return "ë‹­ê°€ìŠ´ì‚´";
              if (preferences.includes("seafood")) return "í°ì‚´ìƒì„ ";
            }
            return null;
          };

          Object.values(adaptedMeals).forEach((meal) => {
            meal.foods = meal.foods.map((food) => {
              const foodCategory = food.category;
              if (
                ["meat", "seafood", "plant"].includes(foodCategory) &&
                !preferences.includes(foodCategory)
              ) {
                const replacementName = getReplacement(foodCategory);
                if (replacementName) {
                  const originalTotalProtein = food.protein;
                  const replacementProfile = foodProfiles[replacementName];

                  if (replacementProfile.protein === 0) return food;

                  const newAmount =
                    (originalTotalProtein / replacementProfile.protein) * 100;

                  return {
                    ...food,
                    name: replacementName,
                    category: replacementProfile.category,
                    protein: originalTotalProtein,
                    carb: (newAmount / 100) * replacementProfile.carb,
                    fat: (newAmount / 100) * replacementProfile.fat,
                    baseAmount: Math.round(newAmount),
                    unit: replacementProfile.unit,
                    amount: `${Math.round(newAmount)}${
                      replacementProfile.unit
                    }`,
                  };
                }
              }
              return food;
            });
          });

          return adaptedMeals;
        }

        function balanceMealMacrosIteratively(baseMeals, targetMacros) {
          let adjustedMeals = JSON.parse(JSON.stringify(baseMeals));
          const dampeningFactor = 0.4;
          const maxIterations = 25;

          for (let i = 0; i < maxIterations; i++) {
            let currentTotals = { protein: 0, carb: 0, fat: 0 };
            Object.values(adjustedMeals).forEach((meal) => {
              meal.foods.forEach((food) => {
                currentTotals.protein += food.protein;
                currentTotals.carb += food.carb;
                currentTotals.fat += food.fat;
              });
            });

            const ratios = {
              protein:
                currentTotals.protein > 0
                  ? targetMacros.protein / currentTotals.protein
                  : 1,
              carb:
                currentTotals.carb > 0
                  ? targetMacros.carbs / currentTotals.carb
                  : 1,
              fat:
                currentTotals.fat > 0
                  ? targetMacros.fat / currentTotals.fat
                  : 1,
            };

            if (
              Math.abs(ratios.protein - 1) < 0.05 &&
              Math.abs(ratios.carb - 1) < 0.05 &&
              Math.abs(ratios.fat - 1) < 0.05
            ) {
              break;
            }

            Object.values(adjustedMeals).forEach((meal) => {
              meal.foods.forEach((food) => {
                const primaryNutrient = getPrimaryNutrient(food.name);
                let adjustmentRatio = ratios[primaryNutrient];

                const foodTotalCalories =
                  food.protein * 4 + food.carb * 4 + food.fat * 9;
                if (foodTotalCalories > 0) {
                  const fatCalorieContribution =
                    (food.fat * 9) / foodTotalCalories;
                  if (ratios.fat < 0.98 && fatCalorieContribution > 0.3) {
                    adjustmentRatio = (adjustmentRatio + ratios.fat * 2) / 3;
                  }
                }

                const effectiveRatio =
                  1 + (adjustmentRatio - 1) * dampeningFactor;

                const originalMacrosPerBase = {
                  protein: food.protein / food.baseAmount,
                  carb: food.carb / food.baseAmount,
                  fat: food.fat / food.baseAmount,
                };

                let newAmount = food.baseAmount * effectiveRatio;
                newAmount = Math.max(newAmount, 1);

                food.baseAmount = newAmount;
                food.protein = newAmount * originalMacrosPerBase.protein;
                food.carb = newAmount * originalMacrosPerBase.carb;
                food.fat = newAmount * originalMacrosPerBase.fat;

                if (food.unit === "ê°œ" || food.unit === "ì¥") {
                  food.amount = `${parseFloat(newAmount.toFixed(1))}${
                    food.unit
                  }`;
                } else {
                  food.amount = `${Math.round(newAmount)}${food.unit}`;
                }
              });
            });
          }
          return adjustedMeals;
        }

        function calculateCalories(weight, goal, activity) {
          const age = 25;
          const height = 170;
          const bmr = 88.362 + 13.397 * weight + 4.799 * height - 5.677 * age;
          const activityMultipliers = {
            low: 1.375,
            moderate: 1.55,
            high: 1.725,
          };
          const tdee = bmr * activityMultipliers[activity];
          const goalMultiplier = scientificMealData[goal].calorieMultiplier;
          return Math.round(tdee * goalMultiplier);
        }

        function calculateMacros(totalCalories, goal) {
          const data = scientificMealData[goal];
          const proteinCalories = totalCalories * data.proteinRatio;
          const carbCalories = totalCalories * data.carbRatio;
          const fatCalories = totalCalories * data.fatRatio;
          return {
            protein: Math.round(proteinCalories / 4),
            carbs: Math.round(carbCalories / 4),
            fat: Math.round(fatCalories / 9),
            totalCalories: totalCalories,
          };
        }

        document
          .getElementById("proteinForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            calculateAndDisplay();
          });

        function calculateAndDisplay() {
          const weight = parseFloat(document.getElementById("weight").value);
          const goal = document.getElementById("goal").value;
          const activity = document.getElementById("activity").value;
          if (!weight || !goal || !activity) {
            alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          const preferences = Array.from(
            document.querySelectorAll(".preference-label.selected")
          ).map((el) => el.dataset.value);
          if (preferences.length === 0) {
            alert("ì ì–´ë„ í•˜ë‚˜ì˜ ì‹í’ˆ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          document.getElementById("loading").style.display = "block";
          [
            "resultSectionWrapper",
            "mealPlansSection",
            "mainProteinCard",
            "captureSection",
          ].forEach(
            (id) => (document.getElementById(id).style.display = "none")
          );

          setTimeout(() => {
            const goalData = scientificMealData[goal];
            const totalCalories = calculateCalories(weight, goal, activity);
            const macros = calculateMacros(totalCalories, goal);
            const totalProtein = Math.round(weight * goalData.proteinPerKg);
            macros.protein = totalProtein;

            lastCalculationResult = {
              protein: totalProtein,
              goal,
              preferences,
              description: goalData.description,
              calories: totalCalories,
              macros,
              weight,
              activity,
            };

            document.getElementById("loading").style.display = "none";
            displayResults(lastCalculationResult);
            document.getElementById("mainProteinCard").style.display = "block";
            document.getElementById("mainProteinAmount").textContent =
              totalProtein + "g";
            document.getElementById("captureSection").style.display = "block";
          }, 1500);
        }

        function displayResults(result) {
          const { protein, goal, description, calories, macros } = result;

          document.getElementById("goalDescription").textContent = description;

          document.getElementById("nutritionBreakdown").innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-red-500/20 p-4 rounded-lg border border-red-500">
                        <div class="font-bold text-white">ğŸ’ª í•„ìš” ë‹¨ë°±ì§ˆ</div>
                        <div class="text-2xl font-black text-white">${protein}g</div>
                    </div>
                    <div class="bg-gray-500/20 p-4 rounded-lg">
                        <div class="font-bold text-white">ğŸ”¥ í•„ìš” ì¹¼ë¡œë¦¬</div>
                        <div class="text-2xl font-black text-white">${calories}kcal</div>
                    </div>
                    <div class="bg-gray-500/20 p-4 rounded-lg">
                        <div class="font-bold text-white">ğŸš í•„ìš” íƒ„ìˆ˜í™”ë¬¼</div>
                        <div class="text-2xl font-black text-white">${macros.carbs}g</div>
                    </div>
                    <div class="bg-gray-500/20 p-4 rounded-lg">
                        <div class="font-bold text-white">ğŸ¥‘ í•„ìš” ì§€ë°©</div>
                        <div class="text-2xl font-black text-white">${macros.fat}g</div>
                    </div>
                </div>
            `;

          document.getElementById("resultSectionWrapper").style.display =
            "block";
          document
            .getElementById("resultSectionWrapper")
            .scrollIntoView({ behavior: "smooth", block: "start" });
          displayScientificMealPlans(result);
        }

        function createShoppingListHtml(meals) {
          const ingredients = new Map();
          Object.values(meals).forEach((meal) => {
            meal.foods.forEach((food) => {
              if (!ingredients.has(food.name)) {
                ingredients.set(food.name, food);
              }
            });
          });

          const aggregatedIngredients = Array.from(ingredients.values());
          aggregatedIngredients.sort((a, b) => a.name.localeCompare(b.name));

          let html = `<div class="input-card p-8 mb-8 shadow-lg">
                <h4 class="text-center text-xl mb-4 font-bold"><i class="fas fa-shopping-cart text-primary-red"></i> ì‡¼í•‘ë¦¬ìŠ¤íŠ¸</h4>
                <p class="text-center text-gray-400 text-sm mb-6">ì•„ë˜ ì‹ì¬ë£Œë“¤ì„ í´ë¦­í•˜ë©´ ì¿ íŒ¡ì—ì„œ ë°”ë¡œ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
                <div class="d-flex flex-wrap justify-content-center gap-3">`;

          aggregatedIngredients.forEach((ing) => {
            const link = `https://www.coupang.com/np/search?q=${encodeURIComponent(
              ing.name
            )}&channel=user`;
            html += `<a href="${link}" target="_blank" class="bg-card-bg text-text-light px-4 py-2 border border-border-color rounded-full cursor-pointer font-medium whitespace-nowrap hover:border-primary-red hover:text-white transition-all duration-200">
                        ${ing.name}
                     </a>`;
          });

          html += `</div></div>`;
          return html;
        }

        // ğŸ”¥ ìˆ˜ì •ëœ ì´ë©”ì¼ ì „ì†¡ í•¨ìˆ˜ (ì‹¤ì œ ì‘ë™)
        async function sendSubscriptionEmail(email, userProfile) {
          const submitButton = document.querySelector(
            '#subscriptionForm button[type="submit"]'
          );
          const originalText = submitButton.innerHTML;
          const successMessage = document.getElementById(
            "subscriptionSuccessMessage"
          );
          const errorMessage = document.getElementById(
            "subscriptionErrorMessage"
          );

          // ë©”ì‹œì§€ ì´ˆê¸°í™”
          successMessage.style.display = "none";
          errorMessage.style.display = "none";

          console.log("ğŸ”¥ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘:", { email, userProfile });

          try {
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            submitButton.innerHTML =
              '<div class="loading-spinner"></div>ì „ì†¡ ì¤‘...';
            submitButton.disabled = true;

            // ğŸ”¥ í•µì‹¬: text/plainìœ¼ë¡œ CORS ë¬¸ì œ í•´ê²°
            const requestData = {
              email: email,
              protein: userProfile.protein || 0,
              goal: userProfile.goal || "unknown",
              preference: userProfile.preferences
                ? userProfile.preferences.join(", ")
                : "none",
              description: userProfile.description || "no description",
            };

            console.log("ğŸ“¤ ì „ì†¡ ë°ì´í„°:", requestData);

            const response = await fetch(EMAIL_API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "text/plain;charset=utf-8", // ğŸ”¥ CORS í•´ê²° í•µì‹¬
              },
              body: JSON.stringify(requestData),
            });

            console.log("ğŸ“¡ ì‘ë‹µ ìƒíƒœ:", response.status, response.statusText);

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const result = await response.json();
            console.log("âœ… ì‘ë‹µ ê²°ê³¼:", result);

            if (result.result === "success") {
              successMessage.innerHTML = `âœ… <strong>ì‚¬ì „ì˜ˆì•½ ì™„ë£Œ!</strong><br/>
              ${email}ë¡œ í™•ì¸ ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.`;
              successMessage.style.display = "block";
              document.getElementById("emailInput").value = "";

              setTimeout(() => {
                successMessage.style.display = "none";
              }, 5000);
            } else {
              throw new Error(
                result.message || "ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              );
            }
          } catch (error) {
            console.error("ğŸ’¥ ì´ë©”ì¼ êµ¬ë… ì˜¤ë¥˜:", error);

            let errorMsg = "";
            if (
              error.name === "TypeError" &&
              error.message.includes("Failed to fetch")
            ) {
              errorMsg = `âŒ <strong>ì—°ê²° ì‹¤íŒ¨</strong><br/>
              Google Apps Scriptê°€ ì˜¬ë°”ë¥´ê²Œ ë°°í¬ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
              <small>URL: ${EMAIL_API_URL}</small>`;
            } else if (error.message.includes("CORS")) {
              errorMsg = `âŒ <strong>CORS ì˜¤ë¥˜</strong><br/>
              Google Apps Scriptì—ì„œ doOptions() í•¨ìˆ˜ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.`;
            } else {
              errorMsg = `âŒ <strong>ì˜¤ë¥˜ ë°œìƒ:</strong> ${error.message}`;
            }

            errorMessage.innerHTML = errorMsg;
            errorMessage.style.display = "block";

            setTimeout(() => {
              errorMessage.style.display = "none";
            }, 10000);
          } finally {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
          }
        }

        function createSubscriptionCardHtml() {
          return `<div class="input-card p-8 my-8 shadow-lg">
                <h4 class="text-xl mb-2 font-bold">ğŸ¥— mealStack ìì²´ ì‹ë‹¨ íŒ¨í‚¤ì§€ ì‚¬ì „ ì˜ˆì•½ ì•ˆë‚´</h4>
                <p class="text-gray-400 mb-6">ì£¼ 7~8ë§Œì›ì˜ í•˜ë£¨ 3-4ë¼ì˜ ìì²´ ë²Œí¬ì—… ì‹ë‹¨ íŒ¨í‚¤ì§€ë¥¼ ëŸ°ì¹­í•œë‹¤ë©´ ê´€ì‹¬ ìˆìœ¼ì‹¤ê¹Œìš”?</p>
                <form id="subscriptionForm" class="flex justify-center">
                  <input type="email" id="emailInput" class="form-control w-2/3" placeholder="your-email@example.com" required>
                  <button type="submit" class="btn btn-primary ml-2">
                    <i class="fas fa-bell"></i> ì‚¬ì „ì˜ˆì•½ ì•ˆë‚´ ë°›ê¸°
                  </button>
                </form>
                <div id="subscriptionSuccessMessage" class="alert-success" style="display:none;"></div>
                <div id="subscriptionErrorMessage" class="alert-error" style="display:none;"></div>
                <div class="alert-info mt-3">
                  ğŸ’¡ <strong>ì—°ê²° ì •ë³´:</strong><br/>
                  API ìƒíƒœ: ì—°ê²° ëŒ€ê¸° ì¤‘<br/>
                  URL: ${EMAIL_API_URL}
                </div>
                <p class="text-gray-500 text-sm mt-4">ë˜ëŠ” SNS ì±„ë„ì„ íŒ”ë¡œìš°í•˜ê³  ì†Œì‹ì„ ë°›ì•„ë³´ì„¸ìš”!</p>
                <div class="mt-3">
                    <a href="#" aria-label="YouTube" class="text-gray-400 hover:text-white mx-3 text-3xl transition-colors"><i class="fab fa-youtube"></i></a>
                    <a href="#" aria-label="Instagram" class="text-gray-400 hover:text-white mx-3 text-3xl transition-colors"><i class="fab fa-instagram"></i></a>
                </div>
            </div>`;
        }

        function toggleAccordion(headerId, contentId, iconId) {
          const header = document.getElementById(headerId);
          const content = document.getElementById(contentId);
          const icon = document.getElementById(iconId);

          document.querySelectorAll(".custom-accordion-header").forEach((h) => {
            if (h.id !== headerId) {
              h.classList.remove("active");
            }
          });
          document
            .querySelectorAll(".custom-accordion-content")
            .forEach((c) => {
              if (c.id !== contentId) {
                c.classList.remove("active");
              }
            });
          document.querySelectorAll(".accordion-icon").forEach((i) => {
            if (i.id !== iconId) {
              i.classList.remove("rotated");
            }
          });

          header.classList.toggle("active");
          content.classList.toggle("active");
          icon.classList.toggle("rotated");
        }

        function displayScientificMealPlans(result) {
          const { goal, preferences, macros } = result;
          const mealPlansSection = document.getElementById("mealPlansSection");
          const mealPlansContainer = document.getElementById("mealPlans");

          let baseMeals = JSON.parse(
            JSON.stringify(scientificMealData[goal].meals)
          );
          let adaptedForPrefs = adaptMealsByPreference(baseMeals, preferences);
          let adaptedMeals = balanceMealMacrosIteratively(
            adaptedForPrefs,
            macros
          );

          let finalTotals = { protein: 0, carb: 0, fat: 0, calories: 0 };

          let mealCardsHtml = `<div class="my-8">`;
          let isFirst = true;

          Object.keys(adaptedMeals).forEach((mealKey, index) => {
            const mealData = adaptedMeals[mealKey];
            let mealProtein = mealData.foods.reduce(
              (sum, food) => sum + food.protein,
              0
            );
            let mealCarb = mealData.foods.reduce(
              (sum, food) => sum + food.carb,
              0
            );
            let mealFat = mealData.foods.reduce(
              (sum, food) => sum + food.fat,
              0
            );
            let mealCalories = mealProtein * 4 + mealCarb * 4 + mealFat * 9;

            finalTotals.protein += mealProtein;
            finalTotals.carb += mealCarb;
            finalTotals.fat += mealFat;
            finalTotals.calories += mealCalories;

            const headerId = `header-${index}`;
            const contentId = `content-${index}`;
            const iconId = `icon-${index}`;

            mealCardsHtml += `
              <div class="custom-accordion-item">
                <div class="custom-accordion-header ${isFirst ? "active" : ""}" 
                     id="${headerId}"
                     onclick="toggleAccordion('${headerId}', '${contentId}', '${iconId}')">
                  <span>${mealData.name} (ğŸ’ª ${mealProtein.toFixed(0)}g)</span>
                  <i class="fas fa-chevron-down accordion-icon ${
                    isFirst ? "rotated" : ""
                  }" id="${iconId}"></i>
                </div>
                <div class="custom-accordion-content ${
                  isFirst ? "active" : ""
                }" id="${contentId}">
                  <div class="custom-accordion-body">`;

            mealData.foods.forEach((food) => {
              const link = `https://www.coupang.com/np/search?q=${encodeURIComponent(
                food.name
              )}&channel=user`;
              mealCardsHtml += `
                <div class="flex justify-between items-center py-2 border-b border-border-color">
                  <a href="${link}" target="_blank" class="hover:text-primary-red" style="color: var(--text-light);">
                    ${food.name} (${food.amount})
                  </a>
                  <span class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full">
                    ${food.protein.toFixed(1)}g
                  </span>
                </div>`;
            });

            mealCardsHtml += `
                    <div class="mt-4 p-3 rounded-lg" style="background-color: rgba(0,0,0,0.2);">
                      <div class="text-center text-sm text-white/80">
                        íƒ„ìˆ˜í™”ë¬¼: ${mealCarb.toFixed(
                          1
                        )}g | ì§€ë°©: ${mealFat.toFixed(1)}g
                      </div>
                      <div class="text-center text-sm text-white/80 mt-1">
                        ğŸ”¥ ${mealData.name} ì¹¼ë¡œë¦¬: ${Math.round(
              mealCalories
            )}kcal
                      </div>
                    </div>
                  </div>
                </div>
              </div>`;
            isFirst = false;
          });

          mealCardsHtml += `</div>`;

          const shoppingListHtml = createShoppingListHtml(adaptedMeals);
          const totalNutritionHtml = createTotalNutritionCard(
            finalTotals,
            macros
          );
          const subscriptionHtml = createSubscriptionCardHtml();

          mealPlansContainer.innerHTML =
            shoppingListHtml +
            mealCardsHtml +
            totalNutritionHtml +
            subscriptionHtml;
          mealPlansSection.style.display = "block";

          window.toggleAccordion = toggleAccordion;

          // ğŸ”¥ ì´ë©”ì¼ êµ¬ë… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•µì‹¬!)
          document
            .getElementById("subscriptionForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              const email = document.getElementById("emailInput").value.trim();

              console.log("ğŸ“§ êµ¬ë… ì‹œë„:", email);

              if (!email) {
                document.getElementById("subscriptionErrorMessage").innerHTML =
                  "âŒ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                document.getElementById(
                  "subscriptionErrorMessage"
                ).style.display = "block";
                setTimeout(() => {
                  document.getElementById(
                    "subscriptionErrorMessage"
                  ).style.display = "none";
                }, 3000);
                return;
              }

              if (lastCalculationResult) {
                await sendSubscriptionEmail(email, lastCalculationResult);
              } else {
                // ê³„ì‚° ê²°ê³¼ê°€ ì—†ì–´ë„ ì´ë©”ì¼ êµ¬ë…ì€ ê°€ëŠ¥í•˜ë„ë¡
                await sendSubscriptionEmail(email, {
                  protein: 0,
                  goal: "unknown",
                  preferences: [],
                  description: "ì •ë³´ ì—†ìŒ",
                });
              }
            });
        }

        function createTotalNutritionCard(finalTotals, targetMacros) {
          const proteinAch = Math.round(
            (finalTotals.protein / targetMacros.protein) * 100
          );
          const carbAch = Math.round(
            (finalTotals.carb / targetMacros.carbs) * 100
          );
          const fatAch = Math.round((finalTotals.fat / targetMacros.fat) * 100);
          const calAch = Math.round(
            (finalTotals.calories / targetMacros.totalCalories) * 100
          );

          const getAchColor = (rate) =>
            rate >= 90 && rate <= 110
              ? "text-green-400"
              : rate >= 80 && rate <= 120
              ? "text-yellow-400"
              : "text-red-400";

          return `<div class="input-card p-8 my-8 shadow-lg border-2 border-primary-red">
                <h4 class="text-center text-primary-red text-2xl mb-6 font-bold"><i class="fas fa-check-circle"></i> ìµœì¢… ì‹ë‹¨ ìš”ì•½</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <div class="text-gray-400 text-sm">ë‹¨ë°±ì§ˆ</div>
                        <div class="text-2xl font-bold">${finalTotals.protein.toFixed(
                          1
                        )}g</div>
                        <div class="font-bold ${getAchColor(
                          proteinAch
                        )}">ëª©í‘œ ì˜ì–‘ì¹˜ì˜ ${proteinAch}%</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">íƒ„ìˆ˜í™”ë¬¼</div>
                        <div class="text-2xl font-bold">${finalTotals.carb.toFixed(
                          1
                        )}g</div>
                        <div class="font-bold ${getAchColor(
                          carbAch
                        )}">ëª©í‘œ ì˜ì–‘ì¹˜ì˜ ${carbAch}%</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">ì§€ë°©</div>
                        <div class="text-2xl font-bold">${finalTotals.fat.toFixed(
                          1
                        )}g</div>
                        <div class="font-bold ${getAchColor(
                          fatAch
                        )}">ëª©í‘œ ì˜ì–‘ì¹˜ì˜ ${fatAch}%</div>
                    </div>
                     <div>
                        <div class="text-gray-400 text-sm">ì¹¼ë¡œë¦¬</div>
                        <div class="text-2xl font-bold">${Math.round(
                          finalTotals.calories
                        )}kcal</div>
                        <div class="font-bold ${getAchColor(
                          calAch
                        )}">ëª©í‘œ ì˜ì–‘ì¹˜ì˜ ${calAch}%</div>
                    </div>
                </div>
                <div class="text-center mt-6 p-4 rounded-lg" style="background-color: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.3);">
                    <p class="text-gray-300 text-sm mb-0">
                        <i class="fas fa-lightbulb text-yellow-400"></i> 
                        ëª©í‘œ ì˜ì–‘ì¹˜ ì°¸ê³  í›„ ì‹ë‹¨ì—ì„œ ë¶€ì¡±í•œ ë¶€ë¶„ì€ ë” ë“œì…”ë„ ì¢‹ìŠµë‹ˆë‹¤!
                    </p>
                </div>
            </div>`;
        }

        window.captureResult = function () {
          const mealPlansSection = document.getElementById("mealPlansSection");
          if (!lastCalculationResult || !mealPlansSection) {
            alert("ë¨¼ì € ê³„ì‚°ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
            return;
          }
          alert("ì‹ë‹¨í‘œë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");
          html2canvas(mealPlansSection, {
            backgroundColor: "#1a1a1a",
            scale: 1.5,
          })
            .then((canvas) => {
              const link = document.createElement("a");
              link.download = `mealStack_plan_${new Date()
                .toISOString()
                .slice(0, 10)}.png`;
              link.href = canvas.toDataURL("image/png");
              link.click();
            })
            .catch((err) => {
              console.error("ìº¡ì²˜ ì˜¤ë¥˜:", err);
              alert("ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        };

        window.shareResult = function () {
          if (!lastCalculationResult) return;
          const { protein, goal, calories } = lastCalculationResult;
          const goalKorean = document.querySelector(
            `#goal option[value=${goal}]`
          ).textContent;
          const shareText = `ğŸ”¥ ë‚˜ì˜ ë§ì¶¤ ì‹ë‹¨ ê²°ê³¼!\n\nğŸ’ª ë‹¨ë°±ì§ˆ: ${protein}g\nğŸ¯ ëª©í‘œ: ${goalKorean}\nğŸ“Š ì¹¼ë¡œë¦¬: ${calories}kcal\n\nmealStackì—ì„œ ë‹¹ì‹ ë§Œì˜ ì™„ë²½í•œ ì‹ë‹¨ì„ì„ ì°¾ì•„ë³´ì„¸ìš”!`;
          if (navigator.share) {
            navigator.share({
              title: "mealStack ë§ì¶¤ ì‹ë‹¨ ê²°ê³¼",
              text: shareText,
              url: window.location.href,
            });
          } else {
            navigator.clipboard
              .writeText(`${shareText}\n${window.location.href}`)
              .then(() => alert("ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
          }
        };
      });
    </script>
  </body>
</html>
