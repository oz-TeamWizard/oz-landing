<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mealStack - ë§ì¶¤í˜• ë‹¨ë°±ì§ˆ ê³„ì‚°ê¸°</title>
    <meta
      name="description"
      content="ë‹¹ì‹ ì˜ ì²´í˜• ëª©í‘œì— ë§ëŠ” ì™„ë²½í•œ ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ê³¼ ì‹ë‹¨ì„ ì œê³µí•©ë‹ˆë‹¤. ë²Œí¬ì—…, ë¦°ë²Œí¬ì—…, ì»·íŒ…, ìœ ì§€ ëª©ì ë³„ ë§ì¶¤ ì‹ë‹¨ ê³„ì‚°ê¸°"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-red: #dc2626;
        --dark-bg: #1a1a1a;
        --card-bg: #2d2d2d;
        --text-light: #f8f9fa;
        --border-color: #404040;
      }

      body {
        background: linear-gradient(135deg, var(--dark-bg) 0%, #0f0f0f 100%);
        color: var(--text-light);
        font-family: "Arial", sans-serif;
        min-height: 100vh;
      }

      .navbar {
        background: rgba(26, 26, 26, 0.95) !important;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
      }

      .brand-logo {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary-red) !important;
        text-shadow: 0 0 10px rgba(220, 38, 38, 0.3);
      }

      .hero-section {
        padding: 80px 0;
        text-align: center;
      }

      .hero-title {
        font-size: 3.5rem;
        font-weight: 900;
        margin-bottom: 1rem;
        background: linear-gradient(45deg, var(--primary-red), #ff4d4d);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .hero-subtitle {
        font-size: 1.2rem;
        color: #cccccc;
        margin-bottom: 2rem;
      }

      .input-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .form-control,
      .form-select {
        background: #1a1a1a;
        border: 2px solid var(--border-color);
        color: var(--text-light);
        border-radius: 10px;
        padding: 12px 16px;
      }

      .form-control:focus,
      .form-select:focus {
        background: #1a1a1a;
        border-color: var(--primary-red);
        color: var(--text-light);
        box-shadow: 0 0 0 0.25rem rgba(220, 38, 38, 0.25);
      }

      .btn-primary {
        background: linear-gradient(45deg, var(--primary-red), #ff4d4d);
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);
        background: linear-gradient(45deg, #b91c1c, var(--primary-red));
      }

      .result-card {
        background: linear-gradient(135deg, var(--primary-red), #b91c1c);
        border-radius: 20px;
        padding: 3rem 2rem;
        text-align: center;
        margin: 2rem 0;
        box-shadow: 0 15px 35px rgba(220, 38, 38, 0.3);
        display: none;
      }

      .protein-amount {
        font-size: 4rem;
        font-weight: 900;
        color: white;
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        margin-bottom: 0.5rem;
      }

      .protein-label {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.9);
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .meal-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
      }

      .meal-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        border-color: var(--primary-red);
      }

      .meal-title {
        color: var(--primary-red);
        font-weight: bold;
        font-size: 1.3rem;
        margin-bottom: 1rem;
      }

      .food-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      .food-item:last-child {
        border-bottom: none;
      }

      .protein-badge {
        background: var(--primary-red);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .section-title {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin: 4rem 0 2rem 0;
        color: var(--primary-red);
      }

      .loading {
        display: none;
        text-align: center;
        color: var(--primary-red);
      }

      .language-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }

      /* ë©”ì¸ ë‹¨ë°±ì§ˆ ì¹´ë“œ - í›¨ì”¬ ë” ê°•ì¡° */
      #mainProteinCard {
        background: linear-gradient(135deg, var(--primary-red), #ff4d4d, #dc2626) !important;
        border: 3px solid #fff !important;
        border-radius: 25px !important;
        padding: 3rem 2rem !important;
        margin-top: 2rem;
        box-shadow: 0 20px 50px rgba(220, 38, 38, 0.6), 0 0 30px rgba(220, 38, 38, 0.3);
        transition: all 0.4s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }
      #mainProteinCard::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: rotate(45deg);
        transition: all 0.6s ease;
        opacity: 0;
      }
      #mainProteinCard:hover::before {
        opacity: 1;
        transform: rotate(45deg) translate(50%, 50%);
      }
      #mainProteinCard:hover,
      #mainProteinCard:active {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 30px 70px rgba(220, 38, 38, 0.8), 0 0 50px rgba(220, 38, 38, 0.5);
        border-color: #fff !important;
      }
      #mainProteinCard .protein-amount {
        color: #fff !important;
        text-shadow: 0 0 30px rgba(255, 255, 255, 0.8), 0 0 60px rgba(255, 255, 255, 0.4);
        font-size: 5rem !important;
        font-weight: 900 !important;
        animation: pulse 2s infinite;
      }
      #mainProteinCard .protein-label {
        color: rgba(255, 255, 255, 0.95) !important;
        font-weight: 900 !important;
        letter-spacing: 3px !important;
        font-size: 1.4rem !important;
        text-transform: uppercase;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }

      /* ì‹í’ˆ ì„ í˜¸ë„ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
      .preference-section {
        background: rgba(45, 45, 45, 0.5);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
      }

      .preference-checkbox {
        margin: 0.3rem;
      }

      .preference-checkbox input[type="checkbox"] {
        display: none;
      }

      .preference-checkbox label {
        display: inline-block;
        background: var(--card-bg);
        color: var(--text-light);
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        white-space: nowrap;
      }

      .preference-checkbox input[type="checkbox"]:checked + label {
        background: var(--primary-red);
        border-color: var(--primary-red);
        color: white;
        transform: scale(1.05);
      }

      .preference-checkbox label:hover {
        border-color: var(--primary-red);
        transform: scale(1.02);
      }

      /* ìº¡ì²˜ ë²„íŠ¼ */
      .capture-section {
        text-align: center;
        margin: 2rem 0;
      }

      .btn-capture {
        background: linear-gradient(45deg, var(--primary-red), #ff4d4d);
        border: none;
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: bold;
        margin: 0 0.5rem 0.5rem 0.5rem;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-capture:hover {
        background: linear-gradient(45deg, #b91c1c, var(--primary-red));
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);
      }

      /* êµ¬ë… ì„¹ì…˜ */
      .subscription-card {
        background: rgba(45, 45, 45, 0.5);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 2.5rem;
        margin-top: 4rem;
        text-align: center;
      }

      .subscription-title {
        font-size: 2rem;
        font-weight: bold;
        color: var(--text-light);
        margin-bottom: 1rem;
      }

      .subscription-subtitle {
        color: #cccccc;
        margin-bottom: 2rem;
      }

      #subscriptionSuccessMessage {
        display: none;
        color: #28a745;
        font-weight: bold;
        margin-top: 1rem;
      }

      @media (max-width: 768px) {
        .hero-title {
          font-size: 2.5rem;
        }
        .protein-amount {
          font-size: 3rem;
        }
        .input-card {
          padding: 1.5rem;
        }
        .preference-checkbox {
          margin: 0.2rem;
        }
        .preference-checkbox label {
          padding: 0.6rem 1.2rem;
          font-size: 0.9rem;
        }
        .btn-capture {
          padding: 10px 20px;
          font-size: 0.9rem;
          margin: 0.25rem;
        }
        .capture-section {
          margin: 1rem 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Language Toggle -->
    <div class="language-toggle">
      <button class="btn btn-outline-light btn-sm" onclick="switchLanguage()">
        <i class="fas fa-globe"></i> EN
      </button>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand brand-logo" href="#">
          <i class="fas fa-dumbbell"></i> mealStack
        </a>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="container">
        <h1 class="hero-title">ë§ì¶¤í˜• ë‹¨ë°±ì§ˆ ì‹ë‹¨ ê³„ì‚°í•˜ê¸°</h1>
        <p class="hero-subtitle">
          ë‹¹ì‹ ì˜ ì²´í˜• ëª©í‘œì— ë§ëŠ” ì™„ë²½í•œ ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ê³¼ ì‹ë‹¨ì„ ì œê³µí•©ë‹ˆë‹¤
        </p>
      </div>
    </section>

    <!-- Input Section -->
    <section class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="input-card">
            <h3 class="text-center mb-4">
              <i class="fas fa-calculator text-danger"></i> ê³„ì‚° ì‹œì‘í•˜ê¸°
            </h3>

            <form id="proteinForm">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">ëª¸ë¬´ê²Œ (kg)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="weight"
                    min="40"
                    max="150"
                    placeholder="70"
                    required
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">ì²´í˜• ëª©í‘œ</label>
                  <select class="form-select" id="goal" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="bulkup">ë²Œí¬ì—… (ê·¼ìœ¡ ì¦ê°€)</option>
                    <option value="lean_bulkup">ë¦°ë²Œí¬ì—… (ê¹”ë”í•œ ì¦ëŸ‰)</option>
                    <option value="cutting">ì»·íŒ… (ì²´ì§€ë°© ê°ì†Œ)</option>
                    <option value="maintain">ìœ ì§€ (í˜„ìƒ ìœ ì§€)</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">ìš´ë™ íšŸìˆ˜</label>
                  <select class="form-select" id="activity" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="low">ë‚®ìŒ (ì£¼ 3íšŒ ì´í•˜)</option>
                    <option value="moderate">ë³´í†µ (ì£¼ 4-5íšŒ)</option>
                    <option value="high">ë†’ìŒ (ì£¼ 6íšŒ ì´ìƒ)</option>
                  </select>
                </div>
              </div>

              <!-- ì‹í’ˆ ì„ í˜¸ë„ ì„ íƒ -->
              <div class="preference-section">
                <h5 class="mb-3 text-center">
                  ì„ í˜¸í•˜ëŠ” ì‹í’ˆ ì¢…ë¥˜
                  <small class="text-muted d-block">(ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</small>
                </h5>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                  <div class="preference-checkbox">
                    <input type="checkbox" id="meat" value="meat" checked />
                    <label for="meat">
                      <i class="fas fa-drumstick-bite"></i> ìœ¡ë¥˜
                    </label>
                  </div>
                  <div class="preference-checkbox">
                    <input
                      type="checkbox"
                      id="seafood"
                      value="seafood"
                      checked
                    />
                    <label for="seafood">
                      <i class="fas fa-fish"></i> ì–´ë¥˜/í•´ì‚°ë¬¼
                    </label>
                  </div>
                  <div class="preference-checkbox">
                    <input type="checkbox" id="plant" value="plant" checked />
                    <label for="plant">
                      <i class="fas fa-leaf"></i> ì‹ë¬¼ì„±
                    </label>
                  </div>
                </div>
              </div>

              <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="fas fa-bolt"></i> ë‹¨ë°±ì§ˆ ì–‘ ê³„ì‚°í•˜ê¸°
                </button>
              </div>
            </form>
          </div>

          <!-- ë©”ì¸ ë‹¨ë°±ì§ˆ ì¹´ë“œ -->
          <div
            id="mainProteinCard"
            class="result-card"
            style="display: none; margin-top: 1.5rem"
          >
            <div class="protein-amount" id="mainProteinAmount">0</div>
            <div class="protein-label">ì¼ì¼ ê¶Œì¥ ë‹¨ë°±ì§ˆ</div>
          </div>

          <!-- ê²°ê³¼ ìº¡ì²˜ ë²„íŠ¼ -->
          <div
            class="capture-section"
            id="captureSection"
            style="display: none"
          >
            <button class="btn btn-capture" onclick="captureResult()">
              <i class="fas fa-camera"></i> ğŸ“‹ ì‹ë‹¨í‘œ ì´ë¯¸ì§€ë¡œ ì €ì¥
            </button>
            <button class="btn btn-capture" onclick="shareResult()">
              <i class="fas fa-share"></i> ê²°ê³¼ ê³µìœ í•˜ê¸°
            </button>
          </div>

          <!-- ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ì¬ë£Œ ìš”ì•½ ë¦¬ìŠ¤íŠ¸ -->
          <div id="ingredientSummary" style="display: none"></div>
        </div>
      </div>
    </section>

    <!-- Loading -->
    <div class="container">
      <div class="loading" id="loading">
        <i class="fas fa-spinner fa-spin fa-3x text-danger"></i>
        <p class="mt-3">ìµœì ì˜ ì‹ë‹¨ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>

    <!-- Result Section -->
    <section class="container">
      <div id="resultSection" style="display: none">
        <div class="result-card">
          <div class="protein-amount" id="proteinAmount">0</div>
          <div class="protein-label">ì¼ì¼ ê¶Œì¥ ë‹¨ë°±ì§ˆ</div>
          <p class="mt-3 mb-0" id="goalDescription"></p>
        </div>

        <div class="row">
          <div class="col-12">
            <div
              class="input-card"
              style="
                border: 2px solid var(--primary-red);
                background: linear-gradient(
                  135deg,
                  var(--card-bg),
                  rgba(220, 38, 38, 0.1)
                );
              "
            >
              <h5
                style="
                  text-align: center;
                  color: var(--primary-red);
                  font-size: 1.5rem;
                  margin-bottom: 1.5rem;
                "
              >
                <i class="fas fa-chart-pie"></i> ì˜ì–‘ì†Œ ë¶„ë°°
              </h5>
              <div id="nutritionBreakdown" style="text-align: center"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Meal Plans Section -->
    <section class="container" id="mealPlansSection" style="display: none">
      <h2 class="section-title"><i class="fas fa-utensils"></i> ì¶”ì²œ ì‹ë‹¨</h2>
      <div id="mealPlans"></div>
    </section>

    <!-- Subscription Section -->
    <section class="container" id="subscriptionSection">
      <div class="subscription-card">
        <h2 class="subscription-title">
          <i class="fas fa-paper-plane text-danger"></i> mealStack ìì²´ ì‹ë‹¨
          íŒ¨í‚¤ì§€ ì˜ˆì•½ ì•ˆë‚´
        </h2>
        <p class="subscription-subtitle">
          ì£¼ 7~8ë§Œì›ì˜ í•˜ë£¨ 3-4ë¼ì˜ ìì²´ ë²Œí¬ì—… ì‹ë‹¨ íŒ¨í‚¤ì§€ë¥¼ ëŸ°ì¹­í•œë‹¤ë©´ ê´€ì‹¬
          ìˆìœ¼ì‹¤ê¹Œìš”?
        </p>
        <div class="row justify-content-center">
          <div class="col-lg-7">
            <form id="subscriptionForm">
              <div class="input-group mb-3">
                <input
                  type="email"
                  class="form-control"
                  id="emailInput"
                  placeholder="your-email@example.com"
                  required
                />
                <button class="btn btn-primary" type="submit" id="submitButton">
                  <i class="fas fa-bell"></i> ì˜ˆì•½ ì•ˆë‚´ ë°›ì•„ë³´ê¸°
                </button>
              </div>
            </form>
            <div id="subscriptionSuccessMessage">
              <i class="fas fa-check-circle"></i> ì˜ˆì•½ ëª…ë‹¨ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!
              ëŸ°ì¹­ ì‹œ ê°€ì¥ ë¨¼ì € ì•Œë ¤ë“œë¦´ê²Œìš”.
            </div>
          </div>
        </div>
        <hr class="my-4" style="border-color: var(--border-color)" />
        <p class="subscription-subtitle">
          ë˜ëŠ” SNS ì±„ë„ì„ íŒ”ë¡œìš°í•˜ê³  ì†Œì‹ì„ ë°›ì•„ë³´ì„¸ìš”!
        </p>
        <div class="sns-buttons">
          <a href="#" class="btn" aria-label="KakaoTalk Channel"
            ><i class="fas fa-comment"></i
          ></a>
          <a href="#" class="btn" aria-label="Instagram"
            ><i class="fab fa-instagram"></i
          ></a>
          <a href="#" class="btn" aria-label="YouTube"
            ><i class="fab fa-youtube"></i
          ></a>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer
      class="text-center py-5 mt-5"
      style="border-top: 1px solid var(--border-color)"
    >
      <div class="container">
        <p class="text-muted">
          Â© 2025 mealStack. ê±´ê°•í•œ ë‹¨ë°±ì§ˆ ë¼ì´í”„ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
        </p>
      </div>
    </footer>

    <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê²°ê³¼ ìº¡ì²˜ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // ê³„ì‚° ê²°ê³¼ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        let lastCalculationResult = null;

        // ê³¼í•™ì  ê·¼ê±° ê¸°ë°˜ ì •í™•í•œ ì‹ë‹¨ ë°ì´í„°
        const scientificMealData = {
          bulkup: {
            description: "ê·¼ìœ¡ëŸ‰ ì¦ê°€ë¥¼ ìœ„í•œ ê³ ë‹¨ë°± ì‹ë‹¨",
            carbRatio: 0.6, // 60%
            proteinRatio: 0.3, // 30%
            fatRatio: 0.1, // 10%
            proteinPerKg: 2.2, // ì²´ì¤‘ x 2.0-2.4g (ë²Œí¬ì—… ìµœì )
            calorieMultiplier: 1.15, // +15% ì¹¼ë¡œë¦¬
            meals: {
              breakfast: {
                name: "ë²Œí¬ì—… ì•„ì¹¨ (ê³ ì¹¼ë¡œë¦¬)",
                foods: [
                  {
                    name: "ê³„ë€",
                    amount: "3ê°œ",
                    protein: 19.5,
                    carb: 1.5,
                    fat: 15.0,
                  },
                  {
                    name: "í˜„ë¯¸",
                    amount: "80g",
                    protein: 6.3,
                    carb: 58.0,
                    fat: 2.2,
                  },
                  {
                    name: "ë°”ë‚˜ë‚˜",
                    amount: "1ê°œ",
                    protein: 1.1,
                    carb: 23.0,
                    fat: 0.3,
                  },
                  {
                    name: "ê²¬ê³¼ë¥˜",
                    amount: "20g",
                    protein: 4.0,
                    carb: 4.0,
                    fat: 12.0,
                  },
                ],
              },
              lunch: {
                name: "ë²Œí¬ì—… ì ì‹¬ (ë©”ì¸ ì‹ì‚¬)",
                foods: [
                  {
                    name: "ë‹­ê°€ìŠ´ì‚´",
                    amount: "200g",
                    protein: 62.0,
                    carb: 0,
                    fat: 2.0,
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "120g",
                    protein: 9.5,
                    carb: 87.0,
                    fat: 3.3,
                  },
                  {
                    name: "ë¸Œë¡œì½œë¦¬",
                    amount: "100g",
                    protein: 2.8,
                    carb: 7.0,
                    fat: 0.4,
                  },
                  {
                    name: "ì˜¬ë¦¬ë¸Œì˜¤ì¼",
                    amount: "10ml",
                    protein: 0,
                    carb: 0,
                    fat: 10.0,
                  },
                ],
              },
              dinner: {
                name: "ë²Œí¬ì—… ì €ë… (ë‹¨ë°±ì§ˆ ì¤‘ì‹¬)",
                foods: [
                  {
                    name: "ì—°ì–´",
                    amount: "180g",
                    protein: 45.0,
                    carb: 0,
                    fat: 24.0,
                  },
                  {
                    name: "ê³ êµ¬ë§ˆ",
                    amount: "150g",
                    protein: 3.0,
                    carb: 30.0,
                    fat: 0.2,
                  },
                  {
                    name: "ì‹œê¸ˆì¹˜",
                    amount: "100g",
                    protein: 2.9,
                    carb: 2.0,
                    fat: 0.4,
                  },
                ],
              },
              snack: {
                name: "ë²Œí¬ì—… ê°„ì‹ (ìš´ë™ í›„)",
                foods: [
                  {
                    name: "ì›¨ì´ í”„ë¡œí‹´",
                    amount: "35g",
                    protein: 28.0,
                    carb: 3.0,
                    fat: 1.5,
                  },
                  {
                    name: "ì˜¤íŠ¸ë°€",
                    amount: "40g",
                    protein: 5.4,
                    carb: 24.0,
                    fat: 2.4,
                  },
                ],
              },
            },
          },
          lean_bulkup: {
            description: "ì²´ì§€ë°© ì¦ê°€ ìµœì†Œí™”í•˜ë©° ê·¼ìœ¡ëŸ‰ ì¦ê°€",
            carbRatio: 0.5, // 50%
            proteinRatio: 0.3, // 30%
            fatRatio: 0.2, // 20%
            proteinPerKg: 1.9, // ì²´ì¤‘ x 1.8-2.0g (ë¦°ë²Œí¬ì—… ìµœì )
            calorieMultiplier: 1.08, // +8% ì¹¼ë¡œë¦¬
            meals: {
              breakfast: {
                name: "ë¦°ë²Œí¬ì—… ì•„ì¹¨ (í´ë¦°)",
                foods: [
                  {
                    name: "ê³„ë€í°ì",
                    amount: "4ê°œ",
                    protein: 14.0,
                    carb: 0.8,
                    fat: 0.2,
                  },
                  {
                    name: "í†µë°€ë¹µ",
                    amount: "2ì¥",
                    protein: 6.0,
                    carb: 24.0,
                    fat: 2.0,
                  },
                  {
                    name: "ì•„ë³´ì¹´ë„",
                    amount: "50g",
                    protein: 1.0,
                    carb: 4.0,
                    fat: 7.5,
                  },
                ],
              },
              lunch: {
                name: "ë¦°ë²Œí¬ì—… ì ì‹¬ (ê· í˜•)",
                foods: [
                  {
                    name: "ë‹­ê°€ìŠ´ì‚´",
                    amount: "180g",
                    protein: 55.8,
                    carb: 0,
                    fat: 1.8,
                  },
                  {
                    name: "í€´ë…¸ì•„",
                    amount: "70g",
                    protein: 9.9,
                    carb: 40.0,
                    fat: 4.2,
                  },
                  {
                    name: "ì±„ì†ŒìƒëŸ¬ë“œ",
                    amount: "150g",
                    protein: 3.0,
                    carb: 8.0,
                    fat: 0.3,
                  },
                  {
                    name: "ì˜¬ë¦¬ë¸Œì˜¤ì¼",
                    amount: "7ml",
                    protein: 0,
                    carb: 0,
                    fat: 7.0,
                  },
                ],
              },
              dinner: {
                name: "ë¦°ë²Œí¬ì—… ì €ë… (ê°€ë²¼ì›€)",
                foods: [
                  {
                    name: "í°ì‚´ìƒì„ ",
                    amount: "160g",
                    protein: 35.2,
                    carb: 0,
                    fat: 1.6,
                  },
                  {
                    name: "í˜„ë¯¸",
                    amount: "60g",
                    protein: 4.7,
                    carb: 43.5,
                    fat: 1.7,
                  },
                  {
                    name: "ë¸Œë¡œì½œë¦¬",
                    amount: "120g",
                    protein: 3.4,
                    carb: 8.4,
                    fat: 0.5,
                  },
                ],
              },
              snack: {
                name: "ë¦°ë²Œí¬ì—… ê°„ì‹ (ì €ì§€ë°©)",
                foods: [
                  {
                    name: "ê·¸ë¦­ìš”ê±°íŠ¸",
                    amount: "150g",
                    protein: 15.0,
                    carb: 9.0,
                    fat: 0.75,
                  },
                  {
                    name: "ë² ë¦¬ë¥˜",
                    amount: "80g",
                    protein: 0.6,
                    carb: 12.0,
                    fat: 0.2,
                  },
                ],
              },
            },
          },
          cutting: {
            description: "ê·¼ìœ¡ëŸ‰ ë³´ì¡´í•˜ë©° ì²´ì§€ë°© ê°ì†Œ",
            carbRatio: 0.4, // 40%
            proteinRatio: 0.4, // 40%
            fatRatio: 0.2, // 20%
            proteinPerKg: 2.4, // ì²´ì¤‘ x 2.2-2.6g (ì»·íŒ…ì‹œ ê·¼ì†ì‹¤ ë°©ì§€)
            calorieMultiplier: 0.85, // -15% ì¹¼ë¡œë¦¬
            meals: {
              breakfast: {
                name: "ì»·íŒ… ì•„ì¹¨ (ê³ ë‹¨ë°±)",
                foods: [
                  {
                    name: "ê³„ë€í°ì",
                    amount: "5ê°œ",
                    protein: 17.5,
                    carb: 1.0,
                    fat: 0.25,
                  },
                  {
                    name: "ì˜¤íŠ¸ë°€",
                    amount: "30g",
                    protein: 4.0,
                    carb: 18.0,
                    fat: 1.8,
                  },
                  {
                    name: "ì‹œê¸ˆì¹˜",
                    amount: "100g",
                    protein: 2.9,
                    carb: 2.0,
                    fat: 0.4,
                  },
                ],
              },
              lunch: {
                name: "ì»·íŒ… ì ì‹¬ (ì €íƒ„ìˆ˜)",
                foods: [
                  {
                    name: "ë‹­ê°€ìŠ´ì‚´",
                    amount: "200g",
                    protein: 62.0,
                    carb: 0,
                    fat: 2.0,
                  },
                  {
                    name: "í˜„ë¯¸",
                    amount: "40g",
                    protein: 3.2,
                    carb: 29.0,
                    fat: 1.1,
                  },
                  {
                    name: "ì±„ì†Œë¯¹ìŠ¤",
                    amount: "200g",
                    protein: 4.0,
                    carb: 10.0,
                    fat: 0.4,
                  },
                ],
              },
              dinner: {
                name: "ì»·íŒ… ì €ë… (ì´ˆì €ì¹¼ë¡œë¦¬)",
                foods: [
                  {
                    name: "í°ì‚´ìƒì„ ",
                    amount: "180g",
                    protein: 39.6,
                    carb: 0,
                    fat: 1.8,
                  },
                  {
                    name: "ë¸Œë¡œì½œë¦¬",
                    amount: "200g",
                    protein: 5.6,
                    carb: 14.0,
                    fat: 0.8,
                  },
                  {
                    name: "ì–‘ìƒì¶”",
                    amount: "100g",
                    protein: 1.4,
                    carb: 3.0,
                    fat: 0.2,
                  },
                ],
              },
              snack: {
                name: "ì»·íŒ… ê°„ì‹ (ë‹¨ë°±ì§ˆ ìœ„ì£¼)",
                foods: [
                  {
                    name: "ì¹´ì œì¸ í”„ë¡œí‹´",
                    amount: "30g",
                    protein: 24.0,
                    carb: 2.0,
                    fat: 1.0,
                  },
                  {
                    name: "ì…€ëŸ¬ë¦¬",
                    amount: "50g",
                    protein: 0.7,
                    carb: 1.5,
                    fat: 0.1,
                  },
                ],
              },
            },
          },
          maintain: {
            description: "í˜„ì¬ ì²´í˜• ë° ê±´ê°• ìœ ì§€",
            carbRatio: 0.5, // 50%
            proteinRatio: 0.3, // 30%
            fatRatio: 0.2, // 20%
            proteinPerKg: 1.6, // ì²´ì¤‘ x 1.4-1.8g (ìœ ì§€ ì ì •)
            calorieMultiplier: 1.0, // ìœ ì§€ ì¹¼ë¡œë¦¬
            meals: {
              breakfast: {
                name: "ìœ ì§€ ì•„ì¹¨ (ê· í˜•)",
                foods: [
                  {
                    name: "ê³„ë€",
                    amount: "2ê°œ",
                    protein: 13.0,
                    carb: 1.0,
                    fat: 10.0,
                  },
                  {
                    name: "í†µê³¡ë¬¼í† ìŠ¤íŠ¸",
                    amount: "2ì¥",
                    protein: 6.0,
                    carb: 24.0,
                    fat: 2.0,
                  },
                  {
                    name: "ì•„ëª¬ë“œ",
                    amount: "15g",
                    protein: 3.0,
                    carb: 3.0,
                    fat: 7.5,
                  },
                ],
              },
              lunch: {
                name: "ìœ ì§€ ì ì‹¬ (ì¼ë°˜)",
                foods: [
                  {
                    name: "ë‹­ê°€ìŠ´ì‚´",
                    amount: "150g",
                    protein: 46.5,
                    carb: 0,
                    fat: 1.5,
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "80g",
                    protein: 6.3,
                    carb: 58.0,
                    fat: 2.2,
                  },
                  {
                    name: "ê°ì¢… ë‚˜ë¬¼",
                    amount: "120g",
                    protein: 3.0,
                    carb: 8.0,
                    fat: 0.5,
                  },
                ],
              },
              dinner: {
                name: "ìœ ì§€ ì €ë… (ê°€ì •ì‹)",
                foods: [
                  {
                    name: "ë‘ë¶€",
                    amount: "150g",
                    protein: 12.0,
                    carb: 4.5,
                    fat: 6.0,
                  },
                  {
                    name: "í˜„ë¯¸ë°¥",
                    amount: "60g",
                    protein: 4.7,
                    carb: 43.5,
                    fat: 1.7,
                  },
                  {
                    name: "ë¯¸ì—­êµ­",
                    amount: "200ml",
                    protein: 2.0,
                    carb: 4.0,
                    fat: 0.5,
                  },
                ],
              },
              snack: {
                name: "ìœ ì§€ ê°„ì‹ (ê±´ê°•)",
                foods: [
                  {
                    name: "ê·¸ë¦­ìš”ê±°íŠ¸",
                    amount: "100g",
                    protein: 10.0,
                    carb: 6.0,
                    fat: 0.5,
                  },
                  {
                    name: "ì‚¬ê³¼",
                    amount: "1/2ê°œ",
                    protein: 0.3,
                    carb: 13.0,
                    fat: 0.2,
                  },
                ],
              },
            },
          },
        };

        // ì„ í˜¸ë„ë³„ ì‹ë‹¨ ë³€í˜• ì‹œìŠ¤í…œ
        function adaptMealsByPreference(baseMeals, preferences) {
          const adaptedMeals = JSON.parse(JSON.stringify(baseMeals)); // ê¹Šì€ ë³µì‚¬

          // ì„ í˜¸ë„ì— ë”°ë¥¸ ë‹¨ë°±ì§ˆ ì†ŒìŠ¤ êµì²´
          Object.keys(adaptedMeals).forEach((mealType) => {
            const meal = adaptedMeals[mealType];

            // ìœ¡ë¥˜ ì„ í˜¸ë„ê°€ ì—†ìœ¼ë©´ ë™ë¬¼ì„± ë‹¨ë°±ì§ˆì„ ë‹¤ë¥¸ ê²ƒìœ¼ë¡œ êµì²´
            if (!preferences.includes("meat")) {
              meal.foods = meal.foods.map((food) => {
                if (["ë‹­ê°€ìŠ´ì‚´", "ì†Œê³ ê¸°", "ë¼ì§€ê³ ê¸°"].includes(food.name)) {
                  if (preferences.includes("seafood")) {
                    return {
                      ...food,
                      name: "ì°¸ì¹˜",
                      protein: food.protein * 0.9,
                    };
                  } else if (preferences.includes("plant")) {
                    return {
                      ...food,
                      name: "ë‘ë¶€",
                      protein: food.protein * 0.4,
                      carb: food.carb + 4,
                    };
                  }
                }
                return food;
              });
            }

            // í•´ì‚°ë¬¼ ì„ í˜¸ë„ì— ë”°ë¥¸ ì¡°ì •
            if (preferences.includes("seafood") && mealType === "dinner") {
              meal.foods = meal.foods.map((food) => {
                if (food.name === "ë‹­ê°€ìŠ´ì‚´") {
                  return { ...food, name: "ì—°ì–´", fat: food.fat + 12 };
                }
                return food;
              });
            }

            // ì‹ë¬¼ì„± ì„ í˜¸ë„ì— ë”°ë¥¸ ì¡°ì •
            if (preferences.includes("plant")) {
              // ê°„ì‹ì„ ê²¬ê³¼ë¥˜ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½
              if (mealType === "snack") {
                meal.foods.push({
                  name: "ì•„ëª¬ë“œ",
                  amount: "20g",
                  protein: 4.0,
                  carb: 4.0,
                  fat: 10.0,
                });
              }
            }
          });

          return adaptedMeals;
        }

        // ğŸ¯ ì •ë°€ ì˜ì–‘ì†Œ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜
        function adjustMealsToTargetCalories(
          baseMeals,
          targetCalories,
          targetProtein,
          targetCarbs = null,
          targetFat = null
        ) {
          // ëª©í‘œ ì˜ì–‘ì†Œ ê³„ì‚°
          if (!targetCarbs || !targetFat) {
            const macros = calculateMacros(targetCalories, lastCalculationResult?.goal || 'bulkup');
            targetCarbs = targetCarbs || macros.carbs;
            targetFat = targetFat || macros.fat;
          }

          // 1ë‹¨ê³„: ê¸°ë³¸ ì‹ë‹¨ ë¹„ë¡€ í™•ëŒ€
          const adjustedMeals = scaleBaseMeals(baseMeals, targetProtein, targetCalories);
          
          // 2ë‹¨ê³„: ë¶€ì¡±í•œ ì˜ì–‘ì†Œ ì •ë°€ ë³´ì¶©
          const finalMeals = supplementNutrients(adjustedMeals, targetProtein, targetCarbs, targetFat, targetCalories);
          
          return finalMeals;
        }

        // 1ë‹¨ê³„: ê¸°ë³¸ ì‹ë‹¨ì„ ë‹¨ë°±ì§ˆ ê¸°ì¤€ìœ¼ë¡œ ì ì ˆíˆ í™•ëŒ€
        function scaleBaseMeals(baseMeals, targetProtein, targetCalories) {
          const adjustedMeals = JSON.parse(JSON.stringify(baseMeals));
          
          // ê¸°ë³¸ ì‹ë‹¨ ì˜ì–‘ì†Œ ê³„ì‚°
          let baseProtein = 0;
          let baseCalories = 0;
          
          for (const mealData of Object.values(baseMeals)) {
            for (const food of mealData.foods) {
              baseProtein += food.protein;
              baseCalories += (food.protein * 4 + (food.carb || 0) * 4 + (food.fat || 0) * 9);
            }
          }

          // ë‹¨ë°±ì§ˆê³¼ ì¹¼ë¡œë¦¬ë¥¼ ê³ ë ¤í•œ ì ì ˆí•œ ìŠ¤ì¼€ì¼ë§ ë¹„ìœ¨
          const proteinRatio = targetProtein / baseProtein;
          const calorieRatio = targetCalories / baseCalories;
          
          // ğŸš« ë‹¨ë°±ì§ˆ ê³¼ë‹¤ ë°©ì§€: ëª©í‘œì˜ 120%ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ì œí•œ
          const maxProteinRatio = (targetProtein * 1.2) / baseProtein;
          const limitedProteinRatio = Math.min(proteinRatio, maxProteinRatio);
          
          // ì œí•œëœ ë‹¨ë°±ì§ˆ ë¹„ìœ¨ê³¼ ì¹¼ë¡œë¦¬ ë¹„ìœ¨ì˜ ì¡°í™”í‰ê·  ì‚¬ìš©
          const scalingRatio = (2 * limitedProteinRatio * calorieRatio) / (limitedProteinRatio + calorieRatio);
          const finalRatio = Math.min(scalingRatio, 1.3); // ìµœëŒ€ 30% ì¦ëŸ‰ ì œí•œ (ë” ë³´ìˆ˜ì )

          // ëª¨ë“  ì‹í’ˆì— ë¹„ë¡€ ì ìš©
          for (const mealData of Object.values(adjustedMeals)) {
            for (const food of mealData.foods) {
              const originalAmount = parseFloat(food.amount.match(/\d+/)?.[0] || 100);
              const newAmount = Math.round(originalAmount * finalRatio);
              food.amount = food.amount.replace(/\d+/, newAmount.toString());

              food.protein = Math.round(food.protein * finalRatio * 10) / 10;
              food.carb = Math.round((food.carb || 0) * finalRatio * 10) / 10;
              food.fat = Math.round((food.fat || 0) * finalRatio * 10) / 10;
            }
          }

          return adjustedMeals;
        }

        // 2ë‹¨ê³„: ë¶€ì¡±í•œ ì˜ì–‘ì†Œë¥¼ ì •ë°€í•˜ê²Œ ë³´ì¶© (ë‹¨ë°±ì§ˆ ê³¼ë‹¤ í•´ê²°)
        function supplementNutrients(meals, targetProtein, targetCarbs, targetFat, targetCalories) {
          const adjustedMeals = JSON.parse(JSON.stringify(meals));
          
          // í˜„ì¬ ì˜ì–‘ì†Œ ê³„ì‚°
          let currentProtein = 0;
          let currentCarbs = 0;
          let currentFat = 0;
          let currentCalories = 0;
          
          for (const mealData of Object.values(adjustedMeals)) {
            for (const food of mealData.foods) {
              currentProtein += food.protein;
              currentCarbs += (food.carb || 0);
              currentFat += (food.fat || 0);
              currentCalories += (food.protein * 4 + (food.carb || 0) * 4 + (food.fat || 0) * 9);
            }
          }

          // ë¶€ì¡±ë¶„ ê³„ì‚°
          const proteinGap = targetProtein - currentProtein;
          const carbGap = targetCarbs - currentCarbs;
          const fatGap = targetFat - currentFat;
          
          console.log('ì˜ì–‘ì†Œ ë¶€ì¡±ë¶„:', {proteinGap, carbGap, fatGap});
          console.log('í˜„ì¬ ë‹¨ë°±ì§ˆ:', currentProtein, 'ëª©í‘œ:', targetProtein);

          // ğŸ¯ ë‹¨ë°±ì§ˆ ê³¼ë‹¤ í•´ê²° ì „ëµ
          const proteinOverage = currentProtein - targetProtein;
          const isProteinExcessive = proteinOverage > targetProtein * 0.05; // 5% ì´ˆê³¼ì‹œ ê³¼ë‹¤ë¡œ íŒë‹¨

          const supplementFoods = [];

          // ğŸ”¥ ë‹¨ë°±ì§ˆì´ ê³¼ë‹¤ì¸ ê²½ìš°: íƒ„ìˆ˜í™”ë¬¼/ì§€ë°©ë§Œ ë³´ì¶©í•˜ì—¬ ê· í˜• ë§ì¶”ê¸°
          if (isProteinExcessive) {
            console.log('ë‹¨ë°±ì§ˆ ê³¼ë‹¤ ê°ì§€:', proteinOverage, 'g ì´ˆê³¼');
            
            // íƒ„ìˆ˜í™”ë¬¼ì´ ë¶€ì¡±í•˜ë©´ ìˆœìˆ˜ íƒ„ìˆ˜í™”ë¬¼ ì‹í’ˆìœ¼ë¡œ ë³´ì¶©
            if (carbGap > 5) {
              const carbNeeded = Math.max(carbGap, 0);
              const riceAmount = Math.round(carbNeeded / 0.72);
              supplementFoods.push({
                name: "í˜„ë¯¸ (íƒ„ìˆ˜í™”ë¬¼ ë³´ì¶©)",
                amount: `${riceAmount}g`,
                protein: Math.round(riceAmount * 0.079),
                carb: carbNeeded,
                fat: Math.round(riceAmount * 0.028)
              });
            }

            // ì§€ë°©ì´ ë¶€ì¡±í•˜ë©´ ìˆœìˆ˜ ì§€ë°© ì‹í’ˆìœ¼ë¡œ ë³´ì¶©
            if (fatGap > 2) {
              const fatNeeded = Math.max(fatGap, 0);
              const oilAmount = Math.round(fatNeeded / 0.92);
              supplementFoods.push({
                name: "ì˜¬ë¦¬ë¸Œì˜¤ì¼ (ì§€ë°© ë³´ì¶©)",
                amount: `${oilAmount}g`,
                protein: 0,
                carb: 0,
                fat: fatNeeded
              });
            }

            // ë‹¨ë°±ì§ˆì€ ì ˆëŒ€ ë” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            console.log('ë‹¨ë°±ì§ˆ ê³¼ë‹¤ë¡œ ì¸í•´ ë‹¨ë°±ì§ˆ ë³´ì¶© ê±´ë„ˆëœ€');
            
          } else {
            // ğŸŸ¢ ë‹¨ë°±ì§ˆì´ ì ì • ìˆ˜ì¤€ì¸ ê²½ìš°: ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
            
            // ë‹¨ë°±ì§ˆ ë³´ì¶© (10% ì´ìƒ ë¶€ì¡±í•˜ê³ , í˜„ì¬ê°€ ëª©í‘œì˜ 110% ë¯¸ë§Œì¼ ë•Œë§Œ)
            const proteinOverageLimit = targetProtein * 1.1;
            if (proteinGap > targetProtein * 0.1 && currentProtein < proteinOverageLimit) {
              const proteinNeeded = Math.round(Math.max(proteinGap * 0.5, 0));
              const proteinPowderAmount = Math.round(proteinNeeded / 0.8);
              
              if (currentProtein + proteinNeeded <= targetProtein * 1.2) {
                supplementFoods.push({
                  name: "ì›¨ì´ í”„ë¡œí‹´",
                  amount: `${proteinPowderAmount}g`,
                  protein: proteinNeeded,
                  carb: Math.round(proteinPowderAmount * 0.05),
                  fat: Math.round(proteinPowderAmount * 0.02)
                });
              }
            }

            // íƒ„ìˆ˜í™”ë¬¼ ë³´ì¶©
            if (carbGap > Math.max(targetCarbs * 0.05, 10)) {
              const carbNeeded = Math.max(carbGap, 0);
              const riceAmount = Math.round(carbNeeded / 0.72);
              supplementFoods.push({
                name: "í˜„ë¯¸ ì¶”ê°€",
                amount: `${riceAmount}g`,
                protein: Math.round(riceAmount * 0.079),
                carb: carbNeeded,
                fat: Math.round(riceAmount * 0.028)
              });
            }

            // ì§€ë°© ë³´ì¶©
            if (fatGap > Math.max(targetFat * 0.05, 3)) {
              const fatNeeded = Math.max(fatGap, 0);
              const oilAmount = Math.round(fatNeeded / 0.92);
              supplementFoods.push({
                name: "ì˜¬ë¦¬ë¸Œì˜¤ì¼ ì¶”ê°€",
                amount: `${oilAmount}g`,
                protein: 0,
                carb: 0,
                fat: fatNeeded
              });
            }
          }

          // ë³´ì¶© ì‹í’ˆì´ ìˆìœ¼ë©´ ì¶”ê°€
          if (supplementFoods.length > 0) {
            adjustedMeals.nutrition_supplement = {
              name: isProteinExcessive ? "ê· í˜• ì¡°ì • ë³´ì¶©" : "ì˜ì–‘ì†Œ ì •ë°€ ë³´ì¶©",
              foods: supplementFoods
            };
          }

          return adjustedMeals;
        }

        // ë¼ë‹ˆ ìˆ˜ë¥¼ ëŠ˜ë ¤ì„œ ëª©í‘œ ì˜ì–‘ì†Œ ë‹¬ì„±
        function adjustMealsWithExtraSnacks(
          baseMeals,
          targetCalories,
          targetProtein,
          targetCarbs,
          targetFat
        ) {
          const adjustedMeals = JSON.parse(JSON.stringify(baseMeals));

          // ê¸°ë³¸ ì‹ë‹¨ ì ë‹¹íˆ ì¦ëŸ‰ (ê³¼ë„í•œ ì¦ëŸ‰ ë°©ì§€)
          const baseMultiplier = 1.2;
          for (const mealData of Object.values(adjustedMeals)) {
            for (const food of mealData.foods) {
              const originalAmount = parseFloat(
                food.amount.match(/\d+/)?.[0] || 100
              );
              const newAmount = Math.round(originalAmount * baseMultiplier);
              food.amount = food.amount.replace(/\d+/, newAmount.toString());

              food.protein = Math.round(food.protein * baseMultiplier * 10) / 10;
              food.carb = Math.round((food.carb || 0) * baseMultiplier * 10) / 10;
              food.fat = Math.round((food.fat || 0) * baseMultiplier * 10) / 10;
            }
          }

          // í˜„ì¬ ì˜ì–‘ì†Œ ì¬ê³„ì‚°
          let currentCalories = 0;
          let currentProtein = 0;
          let currentCarbs = 0;
          let currentFat = 0;
          
          for (const mealData of Object.values(adjustedMeals)) {
            for (const food of mealData.foods) {
              currentCalories +=
                food.protein * 4 + (food.carb || 0) * 4 + (food.fat || 0) * 9;
              currentProtein += food.protein;
              currentCarbs += (food.carb || 0);
              currentFat += (food.fat || 0);
            }
          }

          // ğŸ¯ ë¶€ì¡±ë¶„ ê³„ì‚° ë° ë³´ìˆ˜ì  ë³´ì¶©
          const proteinGap = targetProtein - currentProtein;
          const carbGap = targetCarbs - currentCarbs;
          const fatGap = targetFat - currentFat;

          // ë‹¨ë°±ì§ˆì´ 25g ì´ìƒ ë¶€ì¡±í•˜ê³ , í˜„ì¬ê°€ ëª©í‘œì˜ 110% ë¯¸ë§Œì¼ ë•Œë§Œ ë³´ì¶©
          const proteinOverageLimit = targetProtein * 1.1;
          
          if (proteinGap > 25 && currentProtein < proteinOverageLimit) {
            // ë¶€ì¡±ë¶„ì˜ 40%ë§Œ ë³´ì¶© (ë” ë³´ìˆ˜ì )
            const proteinNeeded = Math.round(proteinGap * 0.4);
            const proteinPowderAmount = Math.round(proteinNeeded / 0.8);
            
            // ìµœì¢… í™•ì¸: ë³´ì¶© í›„ì—ë„ ëª©í‘œì˜ 120%ë¥¼ ë„˜ì§€ ì•Šë„ë¡
            if (currentProtein + proteinNeeded <= targetProtein * 1.2) {
              adjustedMeals.pre_workout = {
                name: "ë‹¨ë°±ì§ˆ ë³´ì¶© ê°„ì‹",
                foods: [
                  {
                    name: "ì›¨ì´ í”„ë¡œí‹´",
                    amount: `${proteinPowderAmount}g`,
                    protein: proteinNeeded,
                    carb: Math.round(proteinPowderAmount * 0.05),
                    fat: Math.round(proteinPowderAmount * 0.03),
                  }
                ],
              };
            }
          }

          return adjustedMeals;
        }

        // ì‹ë‹¨ ì´ë¦„ í•œêµ­ì–´ ë³€í™˜
        function getMealNameKorean(mealType) {
          const mealNames = {
            breakfast: "ì•„ì¹¨",
            lunch: "ì ì‹¬",
            dinner: "ì €ë…",
            snack: "ê°„ì‹",
            pre_workout: "ìš´ë™ ì „",
            night_snack: "ì·¨ì¹¨ ì „",
            protein_supplement: "ë‹¨ë°±ì§ˆ ë³´ì¶©",
            nutrition_supplement: "ì˜ì–‘ì†Œ ë³´ì¶©",
          };
          return mealNames[mealType] || mealType;
        }

        // ê³¼í•™ì  ì¹¼ë¡œë¦¬ ê³„ì‚° í•¨ìˆ˜ (Harris-Benedict equation)
        function calculateCalories(weight, goal, activity) {
          // í‰ê·  ì—°ë ¹ 25ì„¸, í‰ê·  í‚¤ 170cm ê°€ì • (ë” ì •í™•í•œ ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” ì‚¬ìš©ì ì…ë ¥ í•„ìš”)
          const age = 25;
          const height = 170;

          // Harris-Benedict ê³µì‹ (ë‚¨ì„± ê¸°ì¤€)
          const bmr = 88.362 + 13.397 * weight + 4.799 * height - 5.677 * age;

          // í™œë™ëŸ‰ ë°°ìˆ˜
          const activityMultipliers = {
            low: 1.25,
            moderate: 1.55,
            high: 1.75,
          };

          const tdee = bmr * activityMultipliers[activity];
          const goalMultiplier = scientificMealData[goal].calorieMultiplier;

          return Math.round(tdee * goalMultiplier);
        }

        // ì •í™•í•œ ì˜ì–‘ì†Œ ê³„ì‚° í•¨ìˆ˜
        function calculateMacros(totalCalories, goal) {
          const data = scientificMealData[goal];

          const carbCalories = totalCalories * data.carbRatio;
          const proteinCalories = totalCalories * data.proteinRatio;
          const fatCalories = totalCalories * data.fatRatio;

          return {
            carbs: Math.round(carbCalories / 4), // íƒ„ìˆ˜í™”ë¬¼ 1g = 4kcal
            protein: Math.round(proteinCalories / 4), // ë‹¨ë°±ì§ˆ 1g = 4kcal
            fat: Math.round(fatCalories / 9), // ì§€ë°© 1g = 9kcal
            totalCalories: totalCalories,
          };
        }

        const mealDistribution = {
          ì•„ì¹¨: 0.25,
          ì ì‹¬: 0.3,
          ì €ë…: 0.3,
          ê°„ì‹: 0.15,
        };

        // í¼ ì œì¶œ ì´ë²¤íŠ¸
        document
          .getElementById("proteinForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            calculateProtein();
          });

        function calculateProtein() {
          const weight = parseFloat(document.getElementById("weight").value);
          const goal = document.getElementById("goal").value;
          const activity = document.getElementById("activity").value;

          if (!weight || !goal || !activity) {
            alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          // ì„ í˜¸ ì‹í’ˆ ê°€ì ¸ì˜¤ê¸°
          const preferences = getSelectedPreferences();
          if (preferences.length === 0) {
            alert("ì ì–´ë„ í•˜ë‚˜ì˜ ì‹í’ˆ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          document.getElementById("loading").style.display = "block";
          document.getElementById("resultSection").style.display = "none";
          document.getElementById("mealPlansSection").style.display = "none";
          document.getElementById("mainProteinCard").style.display = "none";
          document.getElementById("captureSection").style.display = "none";

          setTimeout(() => {
            // ê³¼í•™ì  ê³„ì‚°
            const goalData = scientificMealData[goal];
            const totalProtein = Math.round(weight * goalData.proteinPerKg);
            const totalCalories = calculateCalories(weight, goal, activity);
            const macros = calculateMacros(totalCalories, goal);

            lastCalculationResult = {
              protein: totalProtein,
              goal: goal,
              preferences: preferences,
              description: goalData.description,
              calories: totalCalories,
              macros: macros,
              weight: weight,
              activity: activity,
            };

            document.getElementById("loading").style.display = "none";
            displayResults(
              totalProtein,
              goal,
              weight,
              preferences,
              totalCalories,
              macros
            );
            document.getElementById("mainProteinCard").style.display = "block";
            document.getElementById("mainProteinAmount").textContent =
              totalProtein + "g";
            document.getElementById("captureSection").style.display = "block";
          }, 1500);
        }

        function getSelectedPreferences() {
          const preferences = [];
          if (document.getElementById("meat").checked) preferences.push("meat");
          if (document.getElementById("seafood").checked)
            preferences.push("seafood");
          if (document.getElementById("plant").checked)
            preferences.push("plant");
          return preferences;
        }

        function displayResults(
          totalProtein,
          goal,
          weight,
          preferences,
          totalCalories,
          macros
        ) {
          document.getElementById("proteinAmount").textContent =
            totalProtein + "g";
          document.getElementById("goalDescription").textContent =
            scientificMealData[goal].description;

          const resultSection = document.getElementById("resultSection");
          resultSection.style.display = "block";
          resultSection.scrollIntoView({ behavior: "smooth" });

          // ê³¼í•™ì  ì˜ì–‘ì†Œ ë¶„ë°° í‘œì‹œ (í•„ìš”ëŸ‰ë§Œ í‘œì‹œ)
          document.getElementById("nutritionBreakdown").innerHTML = `
            <div class="d-flex justify-content-between mb-4" style="padding: 20px; background: linear-gradient(45deg, var(--primary-red), #ff4d4d); border-radius: 15px; margin-bottom: 25px;">
              <span style="font-size: 1.4rem; font-weight: bold; color: white;">ğŸ’ª í•„ìš” ë‹¨ë°±ì§ˆ</span>
              <span style="background: white; color: var(--primary-red); padding: 8px 16px; border-radius: 20px; font-size: 1.4rem; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">${totalProtein}g</span>
            </div>
            <div class="d-flex justify-content-between mb-2" style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px;">
              <span style="font-size: 1rem; font-weight: bold;">ğŸ”¥ í•„ìš” ì¹¼ë¡œë¦¬</span>
              <span class="protein-badge" style="background: #666; font-size: 1rem;">${totalCalories}kcal</span>
            </div>
            <div class="d-flex justify-content-between mb-2" style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px;">
              <span style="font-size: 1rem; font-weight: bold;">ğŸš í•„ìš” íƒ„ìˆ˜í™”ë¬¼</span>
              <span class="protein-badge" style="background: #666; font-size: 1rem;">${macros.carbs}g (${Math.round(scientificMealData[goal].carbRatio * 100)}%)</span>
            </div>
            <div class="d-flex justify-content-between mb-2" style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px;">
              <span style="font-size: 1rem; font-weight: bold;">ğŸ¥‘ í•„ìš” ì§€ë°©</span>
              <span class="protein-badge" style="background: #666; font-size: 1rem;">${macros.fat}g (${Math.round(scientificMealData[goal].fatRatio * 100)}%)</span>
            </div>
            <div style="text-align: center; margin-top: 15px; padding: 10px; background: rgba(220, 38, 38, 0.1); border-radius: 10px; border: 1px solid var(--primary-red);">
              <span style="color: var(--primary-red); font-weight: bold; font-size: 0.9rem;">
                ğŸ¯ ${getGoalKorean(goal)} ë§ì¶¤ í•„ìš” ì˜ì–‘ì†Œ
              </span>
            </div>
          `;

          // ê³¼í•™ì  ê¸°ë°˜ ì‹ë‹¨ í‘œì‹œ
          displayScientificMealPlans(
            goal,
            totalProtein,
            preferences,
            totalCalories,
            macros
          );
        }

        function displayScientificMealPlans(
          goal,
          totalProtein,
          preferences,
          totalCalories,
          macros
        ) {
          const mealPlansSection = document.getElementById("mealPlansSection");
          const mealPlans = document.getElementById("mealPlans");

          // ê³¼í•™ì  ê¸°ë°˜ ì‹ë‹¨ ê°€ì ¸ì˜¤ê¸°
          let baseMeals = scientificMealData[goal].meals;

          // ì„ í˜¸ë„ì— ë”°ë¥¸ ì‹ë‹¨ ì¡°ì •
          let adaptedMeals = adaptMealsByPreference(baseMeals, preferences);

          // ğŸ”¥ ëª©í‘œ ì˜ì–‘ì†Œì— ë§ì¶° ì‹ë‹¨ ì–‘ ì¡°ì • (í•µì‹¬!)
          adaptedMeals = adjustMealsToTargetCalories(
            adaptedMeals,
            totalCalories,
            totalProtein,
            macros.carbs,
            macros.fat
          );

          let mealTotalProtein = 0;
          let mealTotalCarb = 0;
          let mealTotalFat = 0;
          let mealTotalCalories = 0;
          let html = "";

          // ì´ ì˜ì–‘ì†Œ ê³„ì‚° (ì¡°ì •ëœ ì‹ë‹¨ ê¸°ì¤€)
          for (const mealData of Object.values(adaptedMeals)) {
            mealTotalProtein += mealData.foods.reduce(
              (sum, food) => sum + food.protein,
              0
            );
            mealTotalCarb += mealData.foods.reduce(
              (sum, food) => sum + (food.carb || 0),
              0
            );
            mealTotalFat += mealData.foods.reduce(
              (sum, food) => sum + (food.fat || 0),
              0
            );
          }
          mealTotalCalories =
            mealTotalProtein * 4 + mealTotalCarb * 4 + mealTotalFat * 9;

          // ì„ í˜¸ë„ ë° ê³¼í•™ì  ë°ì´í„° í‘œì‹œ
          const preferenceText = preferences
            .map((p) => {
              return p === "meat"
                ? "ìœ¡ë¥˜"
                : p === "seafood"
                ? "í•´ì‚°ë¬¼"
                : "ì‹ë¬¼ì„±";
            })
            .join(", ");

          const goalData = scientificMealData[goal];

          // ì¹¼ë¡œë¦¬ ë‹¬ì„±ë¥  ê³„ì‚° ë° ìƒ‰ìƒ ê²°ì •
          const achievementRate = Math.round(
            (mealTotalCalories / totalCalories) * 100
          );
          const achievementColor =
            Math.abs(achievementRate - 100) <= 5 ? "#28a745" : "#ffc107";


          html += '<div class="row">';
          for (const [mealType, mealData] of Object.entries(adaptedMeals)) {
            const mealProtein = mealData.foods.reduce(
              (sum, food) => sum + food.protein,
              0
            );
            const mealCarb = mealData.foods.reduce(
              (sum, food) => sum + (food.carb || 0),
              0
            );
            const mealFat = mealData.foods.reduce(
              (sum, food) => sum + (food.fat || 0),
              0
            );
            const mealCalories = mealProtein * 4 + mealCarb * 4 + mealFat * 9;

            html += `
              <div class="col-md-6 mb-4">
                <div class="meal-card">
                  <h5 class="meal-title">${mealData.name}</h5>
                  <div class="mb-3">
            `;
            mealData.foods.forEach((food) => {
              const link = getCommerceLink(food.name);
              html += `
                <div class="food-item">
                  <span><a href="${link}" target="_blank" style="color:inherit; text-decoration:underline dotted;">${food.name}</a> (${food.amount})</span>
                  <span style="background: linear-gradient(45deg, var(--primary-red), #ff6666); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 900; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3); border: 1px solid rgba(255,255,255,0.2);">ğŸ’ª ${food.protein}g</span>
                </div>
              `;
            });
            html += `
                  </div>
                  <div class="text-center" style="background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(220, 38, 38, 0.1)); padding: 15px; border-radius: 15px; border: 1px solid rgba(220, 38, 38, 0.3);">
                    <div style="background: linear-gradient(45deg, var(--primary-red), #ff4d4d); color: white; padding: 12px 20px; border-radius: 25px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);">
                      <span style="font-size: 1.3rem; font-weight: 900;">ğŸ’ª ë‹¨ë°±ì§ˆ: ${mealProtein.toFixed(
                        1
                      )}g</span>
                    </div>
                    <div style="margin-bottom: 8px; opacity: 0.8; font-size: 0.9rem;">
                      <span>íƒ„ìˆ˜í™”ë¬¼: ${mealCarb.toFixed(1)}g</span> | 
                      <span>ì§€ë°©: ${mealFat.toFixed(1)}g</span>
                    </div>
                    <div style="color: var(--primary-red); font-weight: bold; font-size: 1.1rem;">
                      ğŸ”¥ ${getMealNameKorean(mealType)} ì¹¼ë¡œë¦¬: ${Math.round(
              mealCalories
            )}kcal
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
          html += "</div>";

          // ğŸ“Š ì´ ì˜ì–‘ì„±ë¶„ ì¹´ë“œ ì¶”ê°€
          const totalNutritionCardHtml = createTotalNutritionCard(
            adaptedMeals,
            totalProtein,
            macros.carbs,
            macros.fat,
            totalCalories
          );
          html += totalNutritionCardHtml;

          // ğŸ›’ ì‹ì¬ë£Œ ì‡¼í•‘ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ (ì‹ë‹¨ í‘œì‹œ ì§í›„ì—)
          const shoppingListHtml = displayShoppingList(adaptedMeals);
          html += shoppingListHtml;

          mealPlans.innerHTML = html;
          mealPlansSection.style.display = "block";
          
          // ì‹ë‹¨ ìš”ì•½ ì •ë³´ í‘œì‹œ
          displayIngredientSummary(adaptedMeals);
        }

        function getDefaultMealTemplate(goal) {
          // ê¸°ë³¸ ì‹ë‹¨ í…œí”Œë¦¿ (ëª¨ë“  ì¢…ë¥˜ í¬í•¨)
          const defaultTemplates = {
            bulkup: {
              breakfast: {
                name: "ê³ ë‹¨ë°± ì•„ì¹¨ì‹ì‚¬",
                foods: [
                  { name: "ê³„ë€", amount: "3ê°œ", protein: 19.5, carb: 1.5 },
                  { name: "ê·€ë¦¬", amount: "60g", protein: 10.1, carb: 38 },
                  { name: "ìš°ìœ ", amount: "250ml", protein: 8.5, carb: 12 },
                ],
              },
              lunch: {
                name: "ë²Œí¬ì—… ì ì‹¬",
                foods: [
                  { name: "ë‹­ê°€ìŠ´ì‚´", amount: "200g", protein: 62.0, carb: 0 },
                  { name: "í˜„ë¯¸", amount: "100g", protein: 7.9, carb: 23 },
                  { name: "ë¸Œë¡œì½œë¦¬", amount: "100g", protein: 2.8, carb: 7 },
                ],
              },
              dinner: {
                name: "ë²Œí¬ì—… ì €ë…",
                foods: [
                  { name: "ì—°ì–´", amount: "180g", protein: 45.0, carb: 0 },
                  { name: "ê³ êµ¬ë§ˆ", amount: "150g", protein: 3.0, carb: 30 },
                  { name: "ì‹œê¸ˆì¹˜", amount: "100g", protein: 2.9, carb: 2 },
                ],
              },
              snack: {
                name: "ë²Œí¬ì—… ê°„ì‹",
                foods: [
                  {
                    name: "ì›¨ì´ í”„ë¡œí‹´",
                    amount: "30g",
                    protein: 24.0,
                    carb: 3,
                  },
                  { name: "ë°”ë‚˜ë‚˜", amount: "1ê°œ", protein: 1.1, carb: 23 },
                ],
              },
            },
          };
          return defaultTemplates[goal] || defaultTemplates.bulkup;
        }

        function displayProteinChart() {
          const proteinFoods = [
            { name: "ë‹­ê°€ìŠ´ì‚´", protein: 31.0, category: "ìœ¡ë¥˜" },
            { name: "ì°¸ì¹˜", protein: 28.0, category: "í•´ì‚°ë¬¼" },
            { name: "ê³„ë€", protein: 13.0, category: "ìœ ì œí’ˆ" },
            { name: "ì›¨ì´ í”„ë¡œí‹´", protein: 80.0, category: "ë³´ì¶©ì œ" },
            { name: "ë‘ë¶€", protein: 8.0, category: "ì½©ë¥˜" },
            { name: "ê·¸ë¦­ìš”ê±°íŠ¸", protein: 10.0, category: "ìœ ì œí’ˆ" },
            { name: "ì—°ì–´", protein: 25.0, category: "í•´ì‚°ë¬¼" },
            { name: "ì†Œê³ ê¸°", protein: 26.0, category: "ìœ¡ë¥˜" },
          ];

          const proteinChart = document.getElementById("proteinChart");
          const proteinChartSection = document.getElementById(
            "proteinChartSection"
          );
          let html = "";

          proteinFoods.forEach((food) => {
            html += `
              <div class="col-md-3 col-sm-6 mb-3">
                <div class="meal-card text-center">
                  <h6 class="meal-title">${food.name}</h6>
                  <div class="protein-amount" style="font-size: 1.5rem;">${food.protein}g</div>
                  <small class="text-muted">100gë‹¹</small>
                  <div class="mt-2">
                    <span class="badge bg-secondary">${food.category}</span>
                  </div>
                </div>
              </div>
            `;
          });

          proteinChart.innerHTML = html;
          proteinChartSection.style.display = "block";
        }

        // ì‹ë‹¨ì—ì„œ ëª¨ë“  ì‹ì¬ë£Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
        function extractIngredientsFromMeals(meals) {
          const ingredients = new Map(); // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•´ Map ì‚¬ìš©
          
          for (const mealData of Object.values(meals)) {
            for (const food of mealData.foods) {
              const foodName = food.name;
              const amount = food.amount;
              const protein = food.protein;
              
              if (ingredients.has(foodName)) {
                // ì´ë¯¸ ìˆëŠ” ì‹ì¬ë£Œë©´ ì–‘ê³¼ ë‹¨ë°±ì§ˆ í•©ì‚°
                const existing = ingredients.get(foodName);
                const existingAmount = parseFloat(existing.amount.match(/\d+/)?.[0] || 0);
                const newAmount = parseFloat(amount.match(/\d+/)?.[0] || 0);
                const totalAmount = existingAmount + newAmount;
                const unit = amount.match(/[ê°€-í£a-zA-Z]+$/)?.[0] || 'g';
                
                ingredients.set(foodName, {
                  name: foodName,
                  amount: `${totalAmount}${unit}`,
                  protein: existing.protein + protein,
                  category: getCategoryByFood(foodName)
                });
              } else {
                // ìƒˆë¡œìš´ ì‹ì¬ë£Œ ì¶”ê°€
                ingredients.set(foodName, {
                  name: foodName,
                  amount: amount,
                  protein: protein,
                  category: getCategoryByFood(foodName)
                });
              }
            }
          }
          
          return Array.from(ingredients.values()).sort((a, b) => b.protein - a.protein);
        }

        // ì‹ì¬ë£Œë³„ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
        function getCategoryByFood(foodName) {
          const categories = {
            'ë‹¨ë°±ì§ˆ': ['ë‹­ê°€ìŠ´ì‚´', 'ì†Œê³ ê¸°', 'ë¼ì§€ê³ ê¸°', 'ì—°ì–´', 'ì°¸ì¹˜', 'í°ì‚´ìƒì„ ', 'ê³„ë€', 'ê³„ë€í°ì', 'ì›¨ì´ í”„ë¡œí‹´', 'ì¹´ì œì¸ í”„ë¡œí‹´', 'ì¶”ê°€ ì›¨ì´ í”„ë¡œí‹´'],
            'íƒ„ìˆ˜í™”ë¬¼': ['í˜„ë¯¸', 'í˜„ë¯¸ë°¥', 'í†µë°€ë¹µ', 'í†µê³¡ë¬¼í† ìŠ¤íŠ¸', 'ê³ êµ¬ë§ˆ', 'ë°”ë‚˜ë‚˜', 'ì‚¬ê³¼', 'ì˜¤íŠ¸ë°€', 'í€´ë…¸ì•„', 'ê¿€'],
            'ì±„ì†Œ': ['ë¸Œë¡œì½œë¦¬', 'ì‹œê¸ˆì¹˜', 'ì–‘ìƒì¶”', 'ì±„ì†ŒìƒëŸ¬ë“œ', 'ì±„ì†Œë¯¹ìŠ¤', 'ê°ì¢… ë‚˜ë¬¼', 'ì…€ëŸ¬ë¦¬', 'ë² ë¦¬ë¥˜'],
            'ìœ ì œí’ˆ': ['ìš°ìœ ', 'ê·¸ë¦­ìš”ê±°íŠ¸'],
            'ê²¬ê³¼ë¥˜': ['ì•„ëª¬ë“œ', 'ê²¬ê³¼ë¥˜', 'ì•„ë³´ì¹´ë„'],
            'ê¸°íƒ€': ['ì˜¬ë¦¬ë¸Œì˜¤ì¼', 'ë¯¸ì—­êµ­', 'ë‘ë¶€']
          };
          
          for (const [category, foods] of Object.entries(categories)) {
            if (foods.includes(foodName)) {
              return category;
            }
          }
          return 'ê¸°íƒ€';
        }

        function displayIngredientSummary(goal, preferences) {
          const summaryDiv = document.getElementById("ingredientSummary");
          if (!summaryDiv) return;

          // ì„ í˜¸ë„ì— ë”°ë¥¸ ì¶”ì²œ ì‹ì¬ë£Œ í‘œì‹œ
          let ingredients = [];
          if (preferences.includes("meat")) {
            ingredients.push("ë‹­ê°€ìŠ´ì‚´", "ì†Œê³ ê¸°", "ê³„ë€");
          }
          if (preferences.includes("seafood")) {
            ingredients.push("ì—°ì–´", "ì°¸ì¹˜", "ìƒˆìš°");
          }
          if (preferences.includes("plant")) {
            ingredients.push("ë‘ë¶€", "ë Œí‹¸ì½©", "í€´ë…¸ì•„", "ì•„ëª¬ë“œ");
          }

          let html =
            '<div class="input-card" style="margin-top:1.5rem; text-align:center;">';
          html +=
            '<h5 class="mb-3"><i class="fas fa-shopping-cart text-danger"></i> ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ì¬ë£Œ</h5>';
          html += '<div class="d-flex flex-wrap justify-content-center gap-2">';

          ingredients.forEach((ingredient) => {
            const link = getCommerceLink(ingredient);
            html += `<a href="${link}" target="_blank" class="badge bg-dark border border-danger text-danger px-3 py-2" style="font-size:1rem; text-decoration:none;">${ingredient}</a>`;
          });

          html += "</div></div>";
          summaryDiv.innerHTML = html;
          summaryDiv.style.display = "block";
        }

        // ì‹ì¬ë£Œ ì‡¼í•‘ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ í•¨ìˆ˜
        function displayShoppingList(meals) {
          const ingredients = extractIngredientsFromMeals(meals);
          const categoryGroups = {};
          
          // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
          ingredients.forEach(ingredient => {
            if (!categoryGroups[ingredient.category]) {
              categoryGroups[ingredient.category] = [];
            }
            categoryGroups[ingredient.category].push(ingredient);
          });

          let html = `
            <div class="input-card" style="margin: 2rem 0; background: linear-gradient(135deg, var(--card-bg), rgba(220, 38, 38, 0.05)); border: 2px solid var(--primary-red);">
              <h4 style="color: var(--primary-red); text-align: center; margin-bottom: 1.5rem;">
                <i class="fas fa-shopping-cart"></i> ğŸ›’ í•„ìš”í•œ ì‹ì¬ë£Œ ì‡¼í•‘ë¦¬ìŠ¤íŠ¸
              </h4>
              <p style="text-align: center; color: #ccc; margin-bottom: 2rem; font-size: 0.9rem;">
                ì•„ë˜ ì‹ì¬ë£Œë“¤ì„ í´ë¦­í•˜ë©´ ì¿ íŒ¡ì—ì„œ ë°”ë¡œ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
              </p>
          `;

          // ì¹´í…Œê³ ë¦¬ ìˆœì„œ ì •ì˜
          const categoryOrder = ['ë‹¨ë°±ì§ˆ', 'íƒ„ìˆ˜í™”ë¬¼', 'ì±„ì†Œ', 'ìœ ì œí’ˆ', 'ê²¬ê³¼ë¥˜', 'ê¸°íƒ€'];
          const categoryIcons = {
            'ë‹¨ë°±ì§ˆ': 'ğŸ¥©',
            'íƒ„ìˆ˜í™”ë¬¼': 'ğŸš', 
            'ì±„ì†Œ': 'ğŸ¥¬',
            'ìœ ì œí’ˆ': 'ğŸ¥›',
            'ê²¬ê³¼ë¥˜': 'ğŸ¥œ',
            'ê¸°íƒ€': 'ğŸ§‚'
          };

          categoryOrder.forEach(category => {
            if (categoryGroups[category] && categoryGroups[category].length > 0) {
              html += `
                <div style="margin-bottom: 2rem;">
                  <h6 style="color: var(--primary-red); font-weight: bold; margin-bottom: 1rem; font-size: 1.1rem;">
                    ${categoryIcons[category]} ${category}
                  </h6>
                  <div class="row">
              `;

              categoryGroups[category].forEach(ingredient => {
                const link = getCommerceLink(ingredient.name);
                html += `
                  <div class="col-md-6 col-lg-4 mb-2">
                    <a href="${link}" target="_blank" style="text-decoration: none;">
                      <div style="
                        background: var(--card-bg);
                        border: 1px solid var(--border-color);
                        border-radius: 12px;
                        padding: 12px 15px;
                        transition: all 0.3s ease;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        cursor: pointer;
                      " onmouseover="this.style.borderColor='var(--primary-red)'; this.style.transform='translateY(-2px)'" 
                         onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'">
                        <div>
                          <div style="color: var(--text-light); font-weight: bold; font-size: 0.95rem;">
                            ${ingredient.name}
                          </div>
                          <div style="color: #999; font-size: 0.8rem;">
                            ${ingredient.amount}
                          </div>
                        </div>
                        <div style="
                          background: linear-gradient(45deg, var(--primary-red), #ff4d4d);
                          color: white;
                          padding: 4px 8px;
                          border-radius: 15px;
                          font-size: 0.75rem;
                          font-weight: bold;
                        ">
                          ğŸ’ª ${ingredient.protein.toFixed(1)}g
                        </div>
                      </div>
                    </a>
                  </div>
                `;
              });

              html += `
                  </div>
                </div>
              `;
            }
          });

          // ì´ ì˜ì–‘ì†Œ ìš”ì•½
          const totalProtein = ingredients.reduce((sum, ing) => sum + ing.protein, 0);
          const totalItems = ingredients.length;

          html += `
            <hr style="border-color: var(--border-color); margin: 2rem 0;">
            <div style="text-align: center; background: rgba(220, 38, 38, 0.1); border-radius: 15px; padding: 1.5rem;">
              <div class="row">
                <div class="col-md-4">
                  <div style="color: var(--primary-red); font-weight: bold; font-size: 1.1rem;">
                    ğŸ“¦ ì´ ì‹ì¬ë£Œ ìˆ˜
                  </div>
                  <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">
                    ${totalItems}ê°€ì§€
                  </div>
                </div>
                <div class="col-md-4">
                  <div style="color: var(--primary-red); font-weight: bold; font-size: 1.1rem;">
                    ğŸ’ª ì´ ë‹¨ë°±ì§ˆ
                  </div>
                  <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">
                    ${totalProtein.toFixed(1)}g
                  </div>
                </div>
                <div class="col-md-4">
                  <div style="color: var(--primary-red); font-weight: bold; font-size: 1.1rem;">
                    ğŸ›’ ì˜ˆìƒ ì‡¼í•‘ì‹œê°„
                  </div>
                  <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">
                    ${Math.ceil(totalItems / 5)}ë¶„
                  </div>
                </div>
              </div>
            </div>
            </div>
          `;

          return html;
        }

        // ì´ ì˜ì–‘ì„±ë¶„ ê³„ì‚° ë° ì¹´ë“œ ìƒì„± í•¨ìˆ˜
        function createTotalNutritionCard(meals, targetProtein, targetCarbs, targetFat, targetCalories) {
          // ì´ ì˜ì–‘ì†Œ ê³„ì‚°
          let totalProtein = 0;
          let totalCarbs = 0;
          let totalFat = 0;
          let totalCalories = 0;

          for (const mealData of Object.values(meals)) {
            for (const food of mealData.foods) {
              totalProtein += food.protein;
              totalCarbs += (food.carb || 0);
              totalFat += (food.fat || 0);
              totalCalories += (food.protein * 4 + (food.carb || 0) * 4 + (food.fat || 0) * 9);
            }
          }

          // ë‹¬ì„±ë¥  ê³„ì‚°
          const proteinAchievement = Math.round((totalProtein / targetProtein) * 100);
          const carbAchievement = Math.round((totalCarbs / targetCarbs) * 100);
          const fatAchievement = Math.round((totalFat / targetFat) * 100);
          const calorieAchievement = Math.round((totalCalories / targetCalories) * 100);

          // ë‹¬ì„±ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
          const getAchievementColor = (rate) => {
            if (rate >= 95 && rate <= 105) return '#28a745'; // ë…¹ìƒ‰ (ì™„ë²½)
            if (rate >= 90 && rate <= 110) return '#17a2b8'; // íŒŒë€ìƒ‰ (ìš°ìˆ˜)  
            if (rate >= 85 && rate <= 115) return '#ffc107'; // ë…¸ë€ìƒ‰ (ì–‘í˜¸)
            return '#dc3545'; // ë¹¨ê°„ìƒ‰ (ì¡°ì • í•„ìš”)
          };

          // ì „ì²´ ë‹¬ì„±ë¥  í‰ê· 
          const overallAchievement = Math.round((proteinAchievement + carbAchievement + fatAchievement + calorieAchievement) / 4);

          return `
            <div class="col-12">
              <div class="meal-card" style="
                background: linear-gradient(135deg, var(--card-bg), rgba(220, 38, 38, 0.1));
                border: 2px solid var(--primary-red);
                margin-top: 2rem;
                position: relative;
                overflow: hidden;
              ">
                <div style="
                  position: absolute;
                  top: -50%;
                  right: -50%;
                  width: 200%;
                  height: 200%;
                  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
                  transform: rotate(45deg);
                "></div>
                
                <h4 style="
                  color: var(--primary-red);
                  text-align: center;
                  font-size: 1.6rem;
                  font-weight: bold;
                  margin-bottom: 1.5rem;
                  position: relative;
                  z-index: 2;
                ">
                  ğŸ“Š ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ì´ ì˜ì–‘ì„±ë¶„
                </h4>
                
                <div class="row" style="position: relative; z-index: 2;">
                  <div class="col-md-6 mb-3">
                    <div style="
                      background: rgba(255,255,255,0.05);
                      border-radius: 12px;
                      padding: 1rem;
                      text-align: center;
                    ">
                      <div style="
                        background: linear-gradient(45deg, var(--primary-red), #ff4d4d);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 25px;
                        margin-bottom: 10px;
                        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
                      ">
                        <span style="font-size: 1.4rem; font-weight: 900;">ğŸ’ª ${totalProtein.toFixed(1)}g</span>
                      </div>
                      <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px;">ë‹¨ë°±ì§ˆ</div>
                      <div style="
                        color: ${getAchievementColor(proteinAchievement)};
                        font-weight: bold;
                        font-size: 0.9rem;
                      ">
                        í•„ìš”ëŸ‰ ëŒ€ë¹„ ${proteinAchievement}%
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <div style="
                      background: rgba(255,255,255,0.05);
                      border-radius: 12px;
                      padding: 1rem;
                      text-align: center;
                    ">
                      <div style="
                        background: ${getAchievementColor(calorieAchievement)};
                        color: white;
                        padding: 12px 20px;
                        border-radius: 25px;
                        margin-bottom: 10px;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                      ">
                        <span style="font-size: 1.4rem; font-weight: 900;">ğŸ”¥ ${Math.round(totalCalories)}kcal</span>
                      </div>
                      <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px;">ì¹¼ë¡œë¦¬</div>
                      <div style="
                        color: ${getAchievementColor(calorieAchievement)};
                        font-weight: bold;
                        font-size: 0.9rem;
                      ">
                        í•„ìš”ëŸ‰ ëŒ€ë¹„ ${calorieAchievement}%
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <div style="
                      background: rgba(255,255,255,0.05);
                      border-radius: 12px;
                      padding: 1rem;
                      text-align: center;
                    ">
                      <div style="
                        background: ${getAchievementColor(carbAchievement)};
                        color: white;
                        padding: 12px 20px;
                        border-radius: 25px;
                        margin-bottom: 10px;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                      ">
                        <span style="font-size: 1.2rem; font-weight: 900;">ğŸš ${totalCarbs.toFixed(1)}g</span>
                      </div>
                      <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px;">íƒ„ìˆ˜í™”ë¬¼</div>
                      <div style="
                        color: ${getAchievementColor(carbAchievement)};
                        font-weight: bold;
                        font-size: 0.9rem;
                      ">
                        í•„ìš”ëŸ‰ ëŒ€ë¹„ ${carbAchievement}%
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <div style="
                      background: rgba(255,255,255,0.05);
                      border-radius: 12px;
                      padding: 1rem;
                      text-align: center;
                    ">
                      <div style="
                        background: ${getAchievementColor(fatAchievement)};
                        color: white;
                        padding: 12px 20px;
                        border-radius: 25px;
                        margin-bottom: 10px;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                      ">
                        <span style="font-size: 1.2rem; font-weight: 900;">ğŸ¥‘ ${totalFat.toFixed(1)}g</span>
                      </div>
                      <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px;">ì§€ë°©</div>
                      <div style="
                        color: ${getAchievementColor(fatAchievement)};
                        font-weight: bold;
                        font-size: 0.9rem;
                      ">
                        í•„ìš”ëŸ‰ ëŒ€ë¹„ ${fatAchievement}%
                      </div>
                    </div>
                  </div>
                </div>
                
                <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                
                <div style="
                  text-align: center;
                  background: rgba(220, 38, 38, 0.1);
                  border-radius: 15px;
                  padding: 1.5rem;
                  position: relative;
                  z-index: 2;
                ">
                  <div style="
                    color: var(--primary-red);
                    font-size: 1.2rem;
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                  ">
                    ğŸ¯ ì „ì²´ ì˜ì–‘ ê· í˜•ë„
                  </div>
                  <div style="
                    color: ${getAchievementColor(overallAchievement)};
                    font-size: 2rem;
                    font-weight: 900;
                    margin-bottom: 0.5rem;
                  ">
                    ${overallAchievement}%
                  </div>
                  <div style="color: #ccc; font-size: 0.9rem;">
                    ${overallAchievement >= 95 && overallAchievement <= 105 ? 'ğŸŸ¢ ì™„ë²½í•œ ì˜ì–‘ ê· í˜•!' : 
                      overallAchievement >= 90 && overallAchievement <= 110 ? 'ğŸ”µ í›Œë¥­í•œ ì˜ì–‘ ê· í˜•!' :
                      overallAchievement >= 85 && overallAchievement <= 115 ? 'ğŸŸ¡ ì–‘í˜¸í•œ ì˜ì–‘ ê· í˜•' :
                      'ğŸ”´ ì˜ì–‘ ê· í˜• ì¡°ì • í•„ìš”'}
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        function getCommerceLink(foodName) {
          return `https://www.coupang.com/np/search?component=&q=${encodeURIComponent(
            foodName + ' ì‹ì¬ë£Œ'
          )}&channel=user`;
        }

        // ê²°ê³¼ ìº¡ì²˜ í•¨ìˆ˜ (ì™„ì „í•œ ì‹ë‹¨í‘œ ìº¡ì²˜)
        window.captureResult = function () {
          if (!lastCalculationResult) {
            alert("ë¨¼ì € ë‹¨ë°±ì§ˆ ê³„ì‚°ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
            return;
          }

          // ìº¡ì²˜í•  ì‹ë‹¨í‘œ ì»¨í…Œì´ë„ˆ ìƒì„±
          const captureContainer = document.createElement("div");
          captureContainer.style.background =
            "linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%)";
          captureContainer.style.padding = "30px";
          captureContainer.style.borderRadius = "20px";
          captureContainer.style.color = "#f8f9fa";
          captureContainer.style.fontFamily = "Arial, sans-serif";
          captureContainer.style.width = "800px";
          captureContainer.style.margin = "0 auto";

          // í—¤ë” ì˜ì—­
          const headerDiv = document.createElement("div");
          headerDiv.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #dc2626; padding-bottom: 20px;">
              <h2 style="color: #dc2626; margin: 0; font-size: 2.5rem;">
                <i class="fas fa-dumbbell"></i> mealStack
              </h2>
              <h3 style="color: #fff; margin: 10px 0 0 0; font-size: 1.8rem;">ë§ì¶¤í˜• ì‹ë‹¨í‘œ</h3>
              <p style="color: #ccc; margin: 5px 0 0 0; font-size: 1rem;">
                ê³¼í•™ì  ê·¼ê±° ê¸°ë°˜ ê°œì¸ë³„ ë§ì¶¤ ì˜ì–‘ ê³„íšì„œ
              </p>
            </div>
          `;
          captureContainer.appendChild(headerDiv);

          // ê°œì¸ ì •ë³´ ì˜ì—­
          const goalKorean = getGoalKorean(lastCalculationResult.goal);
          const preferenceText = lastCalculationResult.preferences
            ? lastCalculationResult.preferences
                .map((p) =>
                  p === "meat" ? "ìœ¡ë¥˜" : p === "seafood" ? "í•´ì‚°ë¬¼" : "ì‹ë¬¼ì„±"
                )
                .join(", ")
            : "ì „ì²´";

          const personalInfoDiv = document.createElement("div");
          personalInfoDiv.innerHTML = `
            <div style="background: #2d2d2d; border: 2px solid #dc2626; border-radius: 15px; padding: 20px; margin-bottom: 25px;">
              <h4 style="color: #dc2626; margin-bottom: 15px; text-align: center;">ğŸ“Š ê°œì¸ ë¶„ì„ ê²°ê³¼</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                <div>
                  <strong style="color: #dc2626;">ì²´í˜• ëª©í‘œ:</strong><br>
                  <span style="color: #fff; font-size: 1.1rem;">${goalKorean}</span>
                </div>
                <div>
                  <strong style="color: #dc2626;">ì„ í˜¸ ì‹í’ˆ:</strong><br>
                  <span style="color: #fff; font-size: 1.1rem;">${preferenceText}</span>
                </div>
                <div>
                  <strong style="color: #dc2626;">ë¼ë‹ˆ êµ¬ì„±:</strong><br>
                  <span style="color: #fff; font-size: 1.1rem;">${
                    document.querySelectorAll(".meal-card").length
                  }ë¼ ì‹ë‹¨</span>
                </div>
              </div>
              <hr style="border-color: #404040; margin: 15px 0;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                <div>
                  <strong style="color: #dc2626;">ì¼ì¼ ëª©í‘œ ë‹¨ë°±ì§ˆ:</strong><br>
                  <span style="color: #fff; font-size: 1.3rem; font-weight: bold;">${
                    lastCalculationResult.protein
                  }g</span>
                </div>
                <div>
                  <strong style="color: #dc2626;">ì¼ì¼ ëª©í‘œ ì¹¼ë¡œë¦¬:</strong><br>
                  <span style="color: #fff; font-size: 1.3rem; font-weight: bold;">${
                    lastCalculationResult.calories || "ê³„ì‚°ëœ"
                  }kcal</span>
                </div>
              </div>
            </div>
          `;
          captureContainer.appendChild(personalInfoDiv);

          // ì‹ë‹¨í‘œ ì˜ì—­ (í˜„ì¬ í‘œì‹œëœ ì‹ë‹¨ì„ ê¸°ë°˜ìœ¼ë¡œ)
          const currentMealPlans = document.getElementById("mealPlans");
          if (currentMealPlans && currentMealPlans.innerHTML) {
            const mealTableDiv = document.createElement("div");
            mealTableDiv.innerHTML = `
              <h4 style="color: #dc2626; margin-bottom: 20px; text-align: center;">
                ğŸ½ï¸ ì˜¤ëŠ˜ì˜ ë§ì¶¤ ì‹ë‹¨í‘œ
              </h4>
            `;

            // í˜„ì¬ ì‹ë‹¨ ë°ì´í„° ë³µì‚¬ ë° ìŠ¤íƒ€ì¼ ì¡°ì •
            const clonedMeals = currentMealPlans.cloneNode(true);

            // ìŠ¤íƒ€ì¼ ì¡°ì •
            clonedMeals.style.color = "#f8f9fa";
            const mealCards = clonedMeals.querySelectorAll(".meal-card");
            mealCards.forEach((card) => {
              card.style.background = "#2d2d2d";
              card.style.border = "1px solid #404040";
              card.style.borderRadius = "10px";
              card.style.padding = "15px";
              card.style.marginBottom = "15px";
            });

            const mealTitles = clonedMeals.querySelectorAll(".meal-title");
            mealTitles.forEach((title) => {
              title.style.color = "#dc2626";
              title.style.marginBottom = "10px";
            });

            const proteinBadges =
              clonedMeals.querySelectorAll(".protein-badge");
            proteinBadges.forEach((badge) => {
              badge.style.background = "#dc2626";
              badge.style.color = "white";
              badge.style.padding = "3px 8px";
              badge.style.borderRadius = "10px";
              badge.style.fontSize = "0.8rem";
            });

            mealTableDiv.appendChild(clonedMeals);
            captureContainer.appendChild(mealTableDiv);
          }

          // ì˜ì–‘ ì •ë³´ ìš”ì•½
          if (lastCalculationResult.macros) {
            const nutritionSummaryDiv = document.createElement("div");

            // ì‹¤ì œ ì‹ë‹¨ ì˜ì–‘ì†Œ ê³„ì‚° (í˜„ì¬ í‘œì‹œëœ ì‹ë‹¨ ê¸°ë°˜)
            const currentMealCards = document.querySelectorAll(".meal-card");
            let actualProtein = 0;
            let actualCarbs = 0;
            let actualFat = 0;
            let actualCalories = 0;

            currentMealCards.forEach((card) => {
              const nutritionText =
                card.querySelector(
                  '[style*="background: rgba(220, 38, 38, 0.1)"]'
                )?.textContent || "";
              const proteinMatch =
                nutritionText.match(/ë‹¨ë°±ì§ˆ:\s*(\d+\.?\d*)g/);
              const carbMatch = nutritionText.match(/íƒ„ìˆ˜í™”ë¬¼:\s*(\d+\.?\d*)g/);
              const fatMatch = nutritionText.match(/ì§€ë°©:\s*(\d+\.?\d*)g/);
              const calorieMatch = nutritionText.match(/(\d+)kcal/);

              if (proteinMatch) actualProtein += parseFloat(proteinMatch[1]);
              if (carbMatch) actualCarbs += parseFloat(carbMatch[1]);
              if (fatMatch) actualFat += parseFloat(fatMatch[1]);
              if (calorieMatch) actualCalories += parseInt(calorieMatch[1]);
            });

            nutritionSummaryDiv.innerHTML = `
              <div style="background: #2d2d2d; border: 1px solid #404040; border-radius: 15px; padding: 20px; margin-top: 20px;">
                <h4 style="color: #dc2626; margin-bottom: 15px; text-align: center;">ğŸ“ˆ ìµœì¢… ì˜ì–‘ì†Œ ë‹¬ì„±ë„</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div style="text-align: center;">
                    <h5 style="color: #dc2626; margin-bottom: 10px;">ğŸ¯ ëª©í‘œ ì˜ì–‘ì†Œ</h5>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                      <div><strong>ì¹¼ë¡œë¦¬:</strong> ${
                        lastCalculationResult.calories
                      }kcal</div>
                      <div><strong>ë‹¨ë°±ì§ˆ:</strong> ${
                        lastCalculationResult.protein
                      }g</div>
                      <div><strong>íƒ„ìˆ˜í™”ë¬¼:</strong> ${
                        lastCalculationResult.macros.carbs
                      }g</div>
                      <div><strong>ì§€ë°©:</strong> ${
                        lastCalculationResult.macros.fat
                      }g</div>
                    </div>
                  </div>
                  <div style="text-align: center;">
                    <h5 style="color: #dc2626; margin-bottom: 10px;">âœ… ì‹¤ì œ ì‹ë‹¨</h5>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                      <div><strong>ì¹¼ë¡œë¦¬:</strong> ${Math.round(
                        actualCalories
                      )}kcal</div>
                      <div><strong>ë‹¨ë°±ì§ˆ:</strong> ${actualProtein.toFixed(
                        1
                      )}g</div>
                      <div><strong>íƒ„ìˆ˜í™”ë¬¼:</strong> ${actualCarbs.toFixed(
                        1
                      )}g</div>
                      <div><strong>ì§€ë°©:</strong> ${actualFat.toFixed(1)}g</div>
                    </div>
                  </div>
                </div>
                <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #404040;">
                  <div style="color: #28a745; font-weight: bold;">
                    ğŸ‰ ì¹¼ë¡œë¦¬ ë‹¬ì„±ë¥ : ${Math.round(
                      (actualCalories / lastCalculationResult.calories) * 100
                    )}%
                  </div>
                </div>
              </div>
            `;
            captureContainer.appendChild(nutritionSummaryDiv);
          }

          // í‘¸í„° ì˜ì—­
          const footerDiv = document.createElement("div");
          footerDiv.innerHTML = `
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #404040;">
              <p style="margin: 0; color: #ccc; font-size: 0.9rem;">
                ìƒì„±ì¼ì‹œ: ${new Date().toLocaleDateString(
                  "ko-KR"
                )} ${new Date().toLocaleTimeString("ko-KR")}
              </p>
              <p style="margin: 5px 0 0 0; color: #dc2626; font-weight: bold;">
                mealStack.kr - ë‹¹ì‹ ì˜ ê±´ê°•í•œ ë³€í™”ë¥¼ ì‘ì›í•©ë‹ˆë‹¤ ğŸ’ª
              </p>
            </div>
          `;
          captureContainer.appendChild(footerDiv);

          // ì„ì‹œë¡œ bodyì— ì¶”ê°€ (í™”ë©´ ë°–ì— ë°°ì¹˜)
          captureContainer.style.position = "absolute";
          captureContainer.style.left = "-9999px";
          document.body.appendChild(captureContainer);

          html2canvas(captureContainer, {
            backgroundColor: "#1a1a1a",
            scale: 2,
            useCORS: true,
            width: 800,
            height: captureContainer.offsetHeight,
            logging: false,
          })
            .then(function (canvas) {
              // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
              const link = document.createElement("a");
              const today = new Date();
              const dateStr =
                today.getFullYear() +
                "ë…„" +
                (today.getMonth() + 1) +
                "ì›”" +
                today.getDate() +
                "ì¼";
              link.download = `mealStack_${goalKorean}_ì‹ë‹¨í‘œ_${dateStr}.png`;
              link.href = canvas.toDataURL("image/png");
              link.click();

              // ì„ì‹œ ìš”ì†Œ ì œê±°
              document.body.removeChild(captureContainer);

              // ì„±ê³µ ë©”ì‹œì§€
              alert(
                "ğŸ“¸ ì‹ë‹¨í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì–¸ì œë“ ì§€ í™•ì¸í•˜ê³  ë”°ë¼í•˜ì„¸ìš”! ğŸ’ª"
              );
            })
            .catch(function (error) {
              console.error("ìº¡ì²˜ ì˜¤ë¥˜:", error);
              document.body.removeChild(captureContainer);
              alert("ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            });
        };

        function getGoalKorean(goal) {
          const goalMap = {
            bulkup: "ë²Œí¬ì—… (ê·¼ìœ¡ ì¦ê°€)",
            lean_bulkup: "ë¦°ë²Œí¬ì—… (ê¹”ë”í•œ ì¦ëŸ‰)",
            cutting: "ì»·íŒ… (ì²´ì§€ë°© ê°ì†Œ)",
            maintain: "ìœ ì§€ (í˜„ìƒ ìœ ì§€)",
          };
          return goalMap[goal] || goal;
        }

        function getCommerceLink(foodName) {
          return `https://www.coupang.com/np/search?component=&q=${encodeURIComponent(
            foodName
          )}&channel=user`;
        }

        function displayIngredientSummary(goal, preferences) {
          const summaryDiv = document.getElementById("ingredientSummary");
          if (!summaryDiv) return;

          // ì„ í˜¸ë„ì— ë”°ë¥¸ ì¶”ì²œ ì‹ì¬ë£Œ í‘œì‹œ
          let ingredients = [];
          if (preferences.includes("meat")) {
            ingredients.push("ë‹­ê°€ìŠ´ì‚´", "ì†Œê³ ê¸°", "ê³„ë€");
          }
          if (preferences.includes("seafood")) {
            ingredients.push("ì—°ì–´", "ì°¸ì¹˜", "ìƒˆìš°");
          }
          if (preferences.includes("plant")) {
            ingredients.push("ë‘ë¶€", "ë Œí‹¸ì½©", "í€´ë…¸ì•„", "ì•„ëª¬ë“œ");
          }

          // ê¸°ë³¸ ì¶”ì²œ ì‹ì¬ë£Œ
          ingredients.push("í˜„ë¯¸", "ê³ êµ¬ë§ˆ", "ë¸Œë¡œì½œë¦¬", "ì‹œê¸ˆì¹˜", "ì˜¤íŠ¸ë°€");

          let html =
            '<div class="input-card" style="margin-top:1.5rem; text-align:center;">';
          html +=
            '<h5 class="mb-3"><i class="fas fa-shopping-cart text-danger"></i> ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ì¬ë£Œ</h5>';
          html += '<div class="d-flex flex-wrap justify-content-center gap-2">';

          // ì¤‘ë³µ ì œê±°
          const uniqueIngredients = [...new Set(ingredients)];

          uniqueIngredients.forEach((ingredient) => {
            const link = getCommerceLink(ingredient);
            html += `<a href="${link}" target="_blank" class="badge bg-dark border border-danger text-danger px-3 py-2" style="font-size:1rem; text-decoration:none;">${ingredient}</a>`;
          });

          html += "</div></div>";
          summaryDiv.innerHTML = html;
          summaryDiv.style.display = "block";
        }

        // ê²°ê³¼ ê³µìœ  í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
        window.shareResult = function () {
          if (!lastCalculationResult) return;

          const goalKorean = getGoalKorean(lastCalculationResult.goal);
          const preferenceText = lastCalculationResult.preferences
            ? lastCalculationResult.preferences
                .map((p) =>
                  p === "meat" ? "ìœ¡ë¥˜" : p === "seafood" ? "í•´ì‚°ë¬¼" : "ì‹ë¬¼ì„±"
                )
                .join(", ")
            : "ì „ì²´";

          const shareText = `ğŸ”¥ ë‚˜ì˜ ë§ì¶¤ ë‹¨ë°±ì§ˆ ê³„ì‚° ê²°ê³¼!

ğŸ’ª ì¼ì¼ ê¶Œì¥ ë‹¨ë°±ì§ˆ: ${lastCalculationResult.protein}g
ğŸ¯ ëª©í‘œ: ${goalKorean}
ğŸ½ï¸ ì„ í˜¸ ì‹í’ˆ: ${preferenceText}
ğŸ“Š ì¹¼ë¡œë¦¬: ${lastCalculationResult.calories || "ê³„ì‚°ëœ"}kcal

ê³¼í•™ì  ê·¼ê±° ê¸°ë°˜ ë§ì¶¤ ì‹ë‹¨ê¹Œì§€!
mealStackì—ì„œ 3ì´ˆ ë§Œì— ê³„ì‚°í•´ë³´ì„¸ìš”!
ğŸ‘‡ ì§€ê¸ˆ ë°”ë¡œ ì²´í—˜`;

          if (navigator.share) {
            navigator.share({
              title: "ğŸ¥— mealStack ë§ì¶¤ ì‹ë‹¨ ê²°ê³¼",
              text: shareText,
              url: window.location.href,
            });
          } else {
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            navigator.clipboard
              .writeText(shareText + "\n" + window.location.href)
              .then(() => {
                alert(
                  "ğŸ“‹ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nSNSë‚˜ ë©”ì‹ ì €ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”."
                );
              })
              .catch(() => {
                // í´ë¦½ë³´ë“œ ì‹¤íŒ¨ì‹œ í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
                const textArea = document.createElement("textarea");
                textArea.value = shareText + "\n" + window.location.href;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                alert("ğŸ“‹ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
              });
          }
        };

        window.switchLanguage = function () {
          alert("ì˜ì–´ ë²„ì „ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤!");
        };

        window.switchLanguage = function () {
          alert("ì˜ì–´ ë²„ì „ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤!");
        };

        // êµ¬ë… í¼ ì²˜ë¦¬
        document
          .getElementById("subscriptionForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            if (!lastCalculationResult) {
              alert('"ê³„ì‚° ì‹œì‘í•˜ê¸°"ë¥¼ ë¨¼ì € í•´ë³´ì„¸ìš”.');
              return;
            }

            const email = document.getElementById("emailInput").value;
            const submitButton = document.getElementById("submitButton");

            if (!email) {
              alert("ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ì „ì†¡ ì¤‘...`;

            const payload = {
              email: email,
              protein: lastCalculationResult.protein,
              goal: lastCalculationResult.goal,
              description: lastCalculationResult.description,
              preferences: lastCalculationResult.preferences,
              calories: lastCalculationResult.calories,
              weight: lastCalculationResult.weight,
              activity: lastCalculationResult.activity,
            };

            // Google Apps Script URL (ì‹¤ì œ ë°°í¬ëœ URLë¡œ êµì²´ í•„ìš”)
            const GAPS_URL =
              "https://script.google.com/macros/s/AKfycbyCd5mEK6qTeRAuETWiRawvH2qSRgAPhuy7itkbnlFe-aGjn5irenmJk4ynO47ZKkP7/exec";

            fetch(GAPS_URL, {
              method: "POST",
              mode: "no-cors",
              cache: "no-cache",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            })
              .then(() => {
                showSubscriptionSuccess();
              })
              .catch((error) => {
                console.error("Error:", error);
                showSubscriptionSuccess();
              })
              .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = `<i class="fas fa-bell"></i> ì˜ˆì•½ ì•ˆë‚´ ë°›ì•„ë³´ê¸°`;
              });
          });

        function showSubscriptionSuccess() {
          const successMessage = document.getElementById(
            "subscriptionSuccessMessage"
          );
          const emailInput = document.getElementById("emailInput");

          successMessage.style.display = "block";
          emailInput.value = "";

          setTimeout(() => {
            successMessage.style.display = "none";
          }, 3000);
        }
      });
    </script>
  </body>
</html>